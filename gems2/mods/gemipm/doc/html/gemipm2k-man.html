<!DOCTYPE doctype PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
  <meta http-equiv="Content-Type"
 content="text/html; charset=iso-8859-1">
  <meta name="GENERATOR"
 content="Mozilla/4.7 [en] (WinNT; I) [Netscape]">
  <title>GEMIPM2K Description</title>
  <meta name="description" content="Version 3.0.0-PSI">
</head>
<body>
<h1><img alt="GEMS-icon" src="gems1.png"
 style="width: 48px; height: 48px;" align="left"> <font color="#000066">
GEMIPM2K version 3</font> </h1>
<h2>Standalone GEM-IPM-2 Solver of Chemical Equilibria by Gibbs Energy
Minimization<br>
</h2>
<hr size="2" width="100%">
<p> </p>
<h3><span style="color: rgb(255, 0, 0);">&lt;Summary under
construction&gt;</span><br>
</h3>
<h3>Contents</h3>
<blockquote>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#1-INTRO">1.
Introduction<br>
  </a></font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#2-STRUCTURE">2.
Structure of GEMIPM2K Code&nbsp; and its Data Exchange Interfaces <br>
  </a></font></p>
  <p><a href="#IPM2-OPERATION"><font face="Helvetica, Arial, sans-serif">2.1.
Brief overview of GEM IPM2 Module Operation</font></a></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#KERNEL">2.2.
The GEM-IPM2 Kernel (GEMIPM2K) and its Work Data Structure IPM (Multi) </a><br>
  </font></p>
  <p><a href="#DATACH"><font face="Helvetica, Arial, sans-serif">2.3.
The DATACH Structure for Chemical System Definition (CSD)<br>
  </font></a></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#DATABR">2.4.
The DATABR Structure for the Node Data Bridge Recipe and
Speciation data</a> <br>
  <br>
  </font><font face="Helvetica, Arial, sans-serif"> <a href="#TNODE">2.5.
The TNode Class - a Minimal Data Exchange
Interface for Coupling with Existing Transport Codes</a><br>
  </font><font face="Helvetica, Arial, sans-serif"><br>
  <a href="#TNODEARRAY">2.6. The TNodeArray Class - a Node Data Storage
for Developing New Coupled Codes</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a
 href="#NUMERICAL_CONTROLS">2.7. Numerical controls of GEMIPM2K
operation</a><br>
  </font> </p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#REQUIREMENTS">3.
Requirements for Programming </a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#CALLFROMCPP">3.1.
When the Calling (FMT)
Program is Written in C++</a><br>
  </font><font face="Helvetica, Arial, sans-serif"><br>
  <a href="#CALLFROMFORTRAN">3.2. When the Calling (FMT) Program is
Written in Fortran-90 </a></font><br>
  </p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#ALPHABETICAL">4.
Compilation and Linking of GEMIPM2K on Various Platforms</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#GNUCPP_FOR">4.1.
GNU C++ (gcc - gfortran)</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#PGICPP_FOR">4.2.
Portland Group C++ (pgcc- pgf)</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a
 href="#OTHER_COMPILERS">4.3. Other compilers and linkers</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#SVN_REP">4.4.
Subversion Repository of GEMIPM2K</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#INPUT_FILES">5.
Input Files</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#TEST_EXAMPLES">6.
Test Examples</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#TEST_TNODE">6.1.
TNode Level</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a
 href="#TEST_TNODEARRAY">6.2. TNodeArray Level</a><br>
  <a href="gemipm2k-man.html#FREEDATA"> </a></font></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><a
 href="#REFERENCES">7. References</a></p>
  <br>
  <hr size="2" width="100%"><br>
  <h2><a name="1-INTRO"></a>1. Introduction</h2>
  <p style="font-family: Helvetica,Arial,sans-serif;">Modern
approaches to reactive mass transport (RMT) or fluid mass transport
(FMT) modelling require simultaneous account for the mass transport of
contaminants through aqueous and/or gas phase in subsurface, together
with their
interaction with wall-rock minerals by means of (ad)sorption,
mineral (co)precipitation, dissolution, etc.&nbsp; These chemical
processes are inherently
complex; they depend on the redox state of the system, and may involve
many phases and chemical species, some of which are
kinetically dependent. Such interactions may adversely affect the mass
transport
via the porosity and permeability changes e.g. due to mineral
dissolution or
precipitation. </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Direct
inclusion of all possible chemical reactions in the mass transport
model is possible (e.g.[<a href="#Ref_Steefel_2009">Steefel and Maher
2009</a>]), but may render it intractable in 2D or 3D space.
If this is the case, the chemical model must be dramatically simplified
to a
few reactions, which makes its chemical plausibility doubtful. The
modeller must make (often arbitrary) decisions about which chemical
interactions are relevant, and which ones can be neglected. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">An
alternative "operator-splitting" approach would be to keep a complex
enough chemical model
in a kind of "black box" which can be applied separately to each
node of the FMT model at each given time point <span
 style="font-style: italic;">t</span>.&nbsp; The&nbsp; input of
the "chemical black box" at time <span style="font-style: italic;">t</span>&nbsp;
is just the vector of bulk chemical composition <span
 style="font-style: italic;">b</span>
of the reactive part of the node, as well as temperature <span
 style="font-style: italic;">T</span>, pressure <span
 style="font-style: italic;">P</span>, and optionally, kinetic
constraints <span style="font-style: italic;">k</span> on some
reactions or amounts of certain components. Some or all of these inputs
could have been changed by the mass transport part on its previous
iteration time step <span style="font-style: italic;">t-</span>1.&nbsp;
  <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The
"chemical black box" equilibration is then applied
to each node independently at time point <span
 style="font-style: italic;">t</span>,
to produce changed speciation <span style="font-style: italic;">n</span>
(amounts of chemical species in all reactive
phases),&nbsp; new phase volumes, redox state (expressed in values of
Eh, pe of aqueous solution,
gas fugacities, etc.), chemical potentials of components, and so on.
This
procedure can also detect a disappearance of some phases or
appearance of some new phases in some nodes (e.g., due to dissolution
or
precipitation of solids). <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">After the
"chemistry" run over all nodes is
finished, the next time step of the FMT algorithm can be done for the
time point <span style="font-style: italic;">t</span>+1, using the
updated concentrations of mobile species in
aqueous
and/or gas phases at time <span style="font-style: italic;">t.</span>
The FMT part redistributes the matter between nodes (subject to mass
concervation), thus producing corrected compositions of reactive part
of
each node. So, the coupled RMT algorithm actually runs over all nodes
twice at the time point <span style="font-style: italic;">t</span>:&nbsp;
once doing a mass transport iteration using node compositions obtained
earlier (at <span style="font-style: italic;">t</span>-1), and
then&nbsp; by applying the "chemical black box" to each node at time <span
 style="font-style: italic;">t</span>, producing the updated speciation
which will be used by the FMT part at the next time point&nbsp; <span
 style="font-style: italic;">t</span>+1.</p>
  <p style="font-family: Helvetica,Arial,sans-serif;">This
idea of "operator-splitting" coupling is not really new and it has
already been implemented in a number of
coupled codes (PHREEQC, GeoSys/RockFlow, MCOTAC, ....). These codes
use different mass transport algorithms, but in most cases the same
type of chemical
solver based on the law of mass action (LMA) and the Newton-Raphson
method
for minimizing the mass balance deviations. However, another type of
chemical solvers based on Gibbs energy minimization (GEM) can also
be&nbsp;
coupled with the FMT codes. </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Both LMA and
GEM can solve the so-called&nbsp; forward
chemical modeling problem, which consists in finding the
concentrations (or
amounts) and activities of chemical species in aqueous and other phases
present
in a complex chemical system in an equilibrium state defined by
temperature <span style="font-style: italic;">T</span>, pressure <span
 style="font-style: italic;">P</span>, and the
system bulk composition <span style="font-style: italic;">b</span>. In
practice, calculations for
solving such problems range from trivial to complex,
depending on
the number of species, phases, and stoichiometry units. The complexity
further
increases when several phases-solutions with redox sensitive components
are
included in the mass balance; a typical case is the aqueous - solid
solution (Aq-SS) system which also involves a non-ideal fluid (gas
mixture) phase. Even more complex systems can be considered, e.g. those
involving (ad)sorption on several co-existing
sorbents. </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Chemical
speciation problems were traditionally solved with help of the LMA
codes,
supported with tools for calculation of
Lippmann functions and saturation indexes. A good introduction
into modern LMA chemical speciation numerical
methods can be found in several textbooks [<a
 href="#Ref_Van-Zeggeren-1970">Van Zeggeren and Storey,
1970</a>; <a href="#Ref_Morel-Hering-1993">Morel and Hering, 1993</a>;
  <a href="#Ref_Bethke-1996">Bethke, 1996</a>] and in the manuals of
speciation codes such as PHREEQC [<a href="#Ref_Parkhurst-Appelo-1999">Parkhurst
and Appelo, 1999</a>] or CHESS
[<a href="#Ref_van-der-Lee-1998">van der Lee, 1998</a>]. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The
advantages of LMA - excellent mass balance accuracy and fast
convergence - are best revealed in the case of simple aqueous
speciation models with known stable pure solid phase assemblage and
known Eh and fugacities of gases. The LMA codes require thermodynamic
data only for the product species (usually aqueous/surface complexes,
minerals, and gases), but not for the master species (usually aqueous
ions) - this "input data economy" can also be viewed as an advantage in
some cases.<br>
  <br>
  <a name="CRITIQUE-LMA"></a>However,
solving with LMA codes the complex equilibria that involve aqueous
electrolyte, many possible condensed phases (including solid
solutions or fluids) is,
in general, an inefficient process. Different approaches
to this problem are used in LMA chemical solvers. In the Geochemists
Workbench [<a href="#Ref_Bethke-1996">Bethke,1996</a>],&nbsp; any pure
mineral phase
is taken as master species. Because there is no way to mix master
species, this program cannot handle solid solutions or gas mixtures at
all. Other LMA codes (such as PHREEQC) consider minerals and gases as
product species. As pointed by [<a href="#Ref_Reed-1982">Reed, 1982</a>],
usually no solids are taken into mass balance in the initial speciation
calculation; after it is done, the saturation indexes are computed for
each stoichiometrically feasible mineral phase, the mineral with the
highest oversaturation is included into the mass balance, the
speciation is computed again, and this loop is repeated until no
supersaturated phases are left in the list. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The real problem
in LMA approach is how to determine the saturation index of the solid
solution
phase or of the gas mixture. For the ideal (solid) solution, this can
be
done over iterations using ionic activities
available from aqueous speciation. For non-ideal SS, this is a problem
which has
no general solution, as explained on Page 94 in [<a
 href="#Ref_Bruno_ea_2007">Bruno et al, 2007</a>]. Because of that, the
LMA chemical solvers can at best treat only ideal solution phases and
simple binary non-ideal solid solutions that can be described using
Lippmann functions and diagrams. If many solids and/or solid solutions
are potentially present,&nbsp; a simple LMA aqueous
speciation calculation turns into a series of many runs controlled by
non-rigorous
test procedures for selecting (over)saturated solids one-by-one,
without a theoretical guarantee of
convergence to a unique result. This kind of retardation is difficult
to evaluate, but, with a large list of possible condensed phases, more
than ten LMA loops may be required to include all stable solids
into
mass balance.&nbsp;<br>
  </p>
<!--[if gte vml 1]><v:shapetype
 id="_x0000_t75" coordsize="21600,21600" o:spt="75" o:preferrelative="t"
 path="m@4@5l@4@11@9@11@9@5xe" filled="f" stroked="f">
 <v:stroke joinstyle="miter"/>
 <v:formulas>
  <v:f eqn="if lineDrawn pixelLineWidth 0"/>
  <v:f eqn="sum @0 1 0"/>
  <v:f eqn="sum 0 0 @1"/>
  <v:f eqn="prod @2 1 2"/>
  <v:f eqn="prod @3 21600 pixelWidth"/>
  <v:f eqn="prod @3 21600 pixelHeight"/>
  <v:f eqn="sum @0 0 1"/>
  <v:f eqn="prod @6 1 2"/>
  <v:f eqn="prod @7 21600 pixelWidth"/>
  <v:f eqn="sum @8 21600 0"/>
  <v:f eqn="prod @7 21600 pixelHeight"/>
  <v:f eqn="sum @10 21600 0"/>
 </v:formulas>
 <v:path o:extrusionok="f" gradientshapeok="t" o:connecttype="rect"/>
 <o:lock v:ext="edit" aspectratio="t"/>
</v:shapetype><v:shape id="_x0000_i1025" type="#_x0000_t75" style='width:15pt;
 height:20.25pt' o:ole="">
 <v:imagedata src="file:///C:\DOCUME~1\KULIK~1.PSI\LOCALS~1\Temp\msohtml1\01\clip_image001.wmz"
  o:title=""/>
</v:shape><![endif]--><!--[if !vml]--><!--[endif]--><!--[if gte mso 9]><xml>
 <o:OLEObject Type="Embed" ProgID="Equation.3" ShapeID="_x0000_i1025"
  DrawAspect="Content" ObjectID="_1230310185">
 </o:OLEObject>
</xml><![endif]-->
  <p style="font-family: Helvetica,Arial,sans-serif;">These drawbacks
of LMA approach do not exist in a
complementary GEM approach [for details, see <a
 href="#Ref_Karpov-ea-1997">Karpov et
al., 1997</a>; <a href="#Ref_Karpov-ea-2001">2001</a>; <a
 href="#Ref_Kulik-ea-2004">Kulik et al., 2004</a>; <a
 href="#Ref_Bruno_ea_2007">Bruno et al., 2007</a>], where total mole
amounts of
chemical
elements <span style="font-style: italic;">n<sub>i</sub></span><sub> </sub>and
(zero)
charge <span style="font-style: italic;">n<sub>z</sub></span> comprise
the
input bulk composition of the chemical system expressed using <span
 style="font-style: italic;">n</span>(<span style="font-style: italic;">N</span>)
Independent Components
(IC). All&nbsp; <span style="font-style: italic;">n</span>(<span
 style="font-style: italic;">L</span>) stoichiometrically
feasible chemical species or Dependent Components (DC) are taken
into the mass balance
through their chemical formulae and mole amounts <span
 style="font-style: italic;">n<sub>j</sub></span>. A given <span
 style="font-style: italic;">j</span>-th DC belongs to a single- or
multi-component aqueous, gaseous, fluid, liquid, solid, or sorption
phase.
The stability of <span style="font-style: italic;">j</span>-th DC at
temperature <span style="font-style: italic;">T</span> and pressure <span
 style="font-style: italic;">P</span>
of
interest is defined by its molar Gibbs energy function <span
 style="font-style: italic;">g<sub>T,P</sub></span>. Activities and
concentrations
of DCs are treated separately in each phase, taking
into account appropriate standard and
reference states, concentration scales, and models of (non)ideal
mixing. </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Conversely,
GEM
algorithms can solve complex Aq-SS
equilibria in a
straightforward way, without supporting tools such as Lippmann
functions or semi-empirical iterative procedures required in LMA Aq-SS
speciation
models. The applicability of GEM to chemical systems is thus limited
only by
the knowledge of
standard-state molar properties of end-members and the non-ideal
interaction
parameters of mixing model for each phase.</p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The
disadvantages of GEM in comparison with LMA codes are (i) slower
convergence in simple aqueous speciation calculations
and (ii) less mass balance accuracy. The performance of GEM can be
dramatically improved using the previous equilibrium speciation as an
initial approximation
for the new run (in "smart initial approximation" mode). The mass
balance accuracy can be made comparable to that of LMA at the cost of a
few additional
GEM iterations (the IPM-2 algorithm), as described in a previous
technical report [<a href="#Ref_TM-44-02-06">Chudnenko ea,
2002</a>]. </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Performance and
chemical feasibility of GEM in complex Aq-SS multiphase
systems may be much better than that of LMA codes
(though no
direct benchmarking is yet available). Another advantage of
GEM method (in "convex programming" variant) is that it yields two
solutions - the "primal" <span style="font-style: italic;">n(x)</span>
for speciation
(analogous to LMA) and the "dual" <span style="font-style: italic;">u(b)</span>
for chemical potentials of
stoichiometry units (not available from LMA solvers). The dual solution
may open
innovative ways to constructing mass transport models for
diffusion-dominated systems, since the
diffusion of any component may be considered as being driven by the
gradient of its chemical
potential.</p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The
present program GEMIPM2K is an implementation of GEM IPM-2
chemical
solver with a simple data exchange interface that makes it possible to
couple any existing FMT code with the GEM&nbsp; "chemical black box" to
produce a coupled modeling code with high chemical plausibility. As
there is no GUI and data exchange occurs via files or in RAM, such code
can be parallelized and compiled on various platforms up to HPC
clusters.&nbsp; <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The traditional
"operator-splitting" coupling, where the chemical information for all
nodes is
stored in the mass transport part which calls the chemical solver for
each node one-by-one, is
supported by the TNode C++ class (and its fortran interface). When a
new FMT code is written, the whole data storage for all nodes can also
be
organized (using a TNodeArray C++ class) into two node arrays (for time
t
and t-1), with each node accessible
from the GEM IPM-2 routines or from the FMT program. </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">This
document describes the structure of GEMIPM2K program and the data
exchange interface (DATACH and DATABR structures), followed by an
overview of TNode and TNodeArray classes and examples of their
usage (see also another document&nbsp; <a
 href="GEMIPM2K%20User%20Reference.html">GEMIPM2K User Reference.html</a>&nbsp;
for detail on using TNode class functions). In a companion document <a
 href="gemipm2k-inp.html">gemipm2k-inp.html</a>,
the format of GEMIPM2K text input/output files is described together
with the reference for data objects encountered in these files. Most of
these data objects are the same as in GEM-Selektor package or similar;
links are
provided wherever necessary. <br>
  </p>
  <p><br>
  </p>
  <hr size="2" width="100%">
  <h2><a name="2-STRUCTURE"></a>2. Structure of GEMIPM2K Code and
its Data Exchange Inteface </h2>
  <p style="font-family: Helvetica,Arial,sans-serif;"><span
 style="font-size: 12pt; font-family: Helvetica,Arial,sans-serif;">GEMIPM2K
package is a set of C++ classes and functions
extracted from the <st1:stockticker w:st="on">GEM-S</st1:stockticker><st1:stockticker
 w:st="on">elektor</st1:stockticker> code package for thermodynamic
modelling by Gibbs energy minimization (<st1:stockticker w:st="on">GEM</st1:stockticker>),
available at <a href="http://gems.web.psi.ch">http://gems.web.psi.ch</a>.
The GEMIPM2K code implements the same GEM chemical solver as in GEMS,
linked to TMulti C++ class
and data structure, enhanced with <st1:stockticker w:st="on">RAM</st1:stockticker>-
and file- data exchange interfaces implemented in TNode and TNodeArray
classes, but cut from the GEMS graphical user interface, database
engine, and script interpreter. <br>
  </span></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><span
 style="font-size: 12pt; font-family: Helvetica,Arial,sans-serif;"><st1:stockticker
 w:st="on"></st1:stockticker> GEMIPM2K has been designed for
coupling the <st1:stockticker w:st="on">GEM</st1:stockticker> chemical
solver with
existing and new fluid-mass-transport (<st1:stockticker w:st="on">FMT</st1:stockticker>)
codes. The program source code is compatible with <st1:stockticker
 w:st="on">ANSI</st1:stockticker>
C++ and can be compiled on many computer platforms (Windows, Linux, <st1:stockticker
 w:st="on">HPC</st1:stockticker> Merlin, Cray XT, etc.) using many
optimizing
compilers (GNU C++, <st1:stockticker w:st="on">PGI</st1:stockticker>
C++, Intel
C++, Microsoft C++, &#8230; ). <br>
  </span></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><span
 style="font-size: 12pt; font-family: Helvetica,Arial,sans-serif;">The
input data can be provided in human-readable ASCII files, the
output can also be written in ASCII files. Alternatively, the whole
data
exchange with a transport code part can be performed in <st1:stockticker
 w:st="on">RAM</st1:stockticker>
using&nbsp; DATACH
and&nbsp; DATABR data structures.
This data exchange interface is implemented in two C++ classes &#8211; TNode
and TNodeArray. <br>
  </span></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><span
 style="font-size: 12pt; font-family: Helvetica,Arial,sans-serif;">The
TNode class provides functionality for attaching GEMIPM2K
kernel to an existing transport model code which keeps the chemical
information
for all nodes and calls <st1:stockticker w:st="on">GEM</st1:stockticker>
calculation for each node separately. The TNodeArray class is built on
top of the TNode class and can store both chemical and dynamic data
for all nodes of the mass transport problem. Recalculation of
equilibrium
states in all nodes after the mass transport step can be done with a
single call (with
internal parallelization possible). This may be suitable for developing
of a
new coupled code. The GEMIPM2K source code is expected to be
distributed in future under
LGPL or similar license.<br>
  <br style="font-family: Helvetica,Arial,sans-serif;">
  </span></p>
  <h3><a name="IPM2-OPERATION"></a>2.1. Brief overview of GEM IPM2
module operation<br>
  </h3>
  <p style="font-family: Helvetica,Arial,sans-serif;">The GEM IPM2
algorithm is described in a companion PSI Technical Report [<a
 href="#Ref_Kulik_ea-2008">Kulik et
al., 2008</a>] , as well as in earlier report [<a
 href="#Ref_TM-44-02-06">Chudnenko et al., 2002</a>]. A short overview
is given in [<a href="#Ref_Bruno_ea_2007">Bruno et al., 2007</a>],
pages 94-104. Recently, the speed of GEM IPM-2 calculations has been
dramatically increased [<a href="#Ref_Dmytrieva-2008">Dmytrieva et al.,
2008</a>] and now is comparable with that of LMA codes, at least in
"smart initial approximation" mode. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The basic idea of
the GEM IPM algorithm consists in finding such a distribution vector <span
 style="font-style: italic;">n </span>of bulk chemical composition of
the system <span style="font-style: italic;">b</span> over its
thermodynamic phases and their components that the total Gibbs energy <span
 style="font-style: italic;">G</span>(<span style="font-style: italic;">n</span>)
of the system is at minimum at temperature and pressure of interest.
Each phase component (chemical species) is represented by its
stoichiometry and the standard chemical potential (molar Gibbs energy
function <span style="font-style: italic;">g</span><sup>o</sup>(<span
 style="font-style: italic;">T,P</span>)) at temperature <span
 style="font-style: italic;">T</span> and pressure <span
 style="font-style: italic;">P</span> of interest. As seen on Fig. 2-1,
the process consists of four major steps. <br>
  <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><img
 style="width: 640px; height: 395px;" alt="IPM flowchart"
 title="GEM IPM general flowchart" src="IPM-Flowchart.png"><br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Fig. 2-1.
Simplified flowchart of GEM IPM algorithm<br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><br>
  <a name="INITIAL_APPROXIMATION"></a>The first step is to obtain an
initial approximation of the <span style="font-style: italic;">n</span>
vector which is close enough to
the <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">n</span>) minimum, so that the GEM process
would succeed in finding the solution of the problem. In principle, any
previously calculated speciation vector<span style="font-style: italic;">
n</span> for this setup of thermodynamic system (even for different <span
 style="font-style: italic;">b, T, P</span>) can be used as initial
approximation in "smart initial approximation" (SIA) mode. If no
previous solution is available at all, or the available one is bad,
then the so-called "automatic initial approximation" (AIA) must
obtained by solving a linear programming (LP) sub-problem using a
modified simplex method. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The LP
sub-problem is constructed by truncating all the mixing terms from
chemical potential expressions for all components of phases-solutions,
which is equivalent to considering any component as a pure phase. Given
  <span style="font-style: italic;">n</span>(<span
 style="font-style: italic;">N</span>) Independent Components (usually
chemical elements and charge) in the bulk composition vector <span
 style="font-style: italic;">b</span>, the simplex solution contains at
most <span style="font-style: italic;">n</span>(<span
 style="font-style: italic;">N</span>) non-zero elements in the AIA
speciation vector <span style="font-style: italic;">n</span>(AIA).
This is also consistent with the Gibbs phase rule. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Usually, the
number of aqueous species is greater than <span
 style="font-style: italic;">n</span>(<span style="font-style: italic;">N</span>).
If the number of stoichiometrically possible phases exceeds n(N), such
system is called "multisystem" [Karpov et al., 1997]. Equilibria in
multisystems cannot be solved directly by LMA algorithm (see a <a
 href="#CRITIQUE-LMA">comment here</a>), but such equilibria can be
solved in one GEM run, if the initial approximation belongs to the
so-called "feasible domain". So, the second step consists in checking
whether the AIA or SIA vector <span style="font-style: italic;">n</span>
is feasible, i.e. whether the mass balance residuals for all
independent components are small enough. This is usually so in the case
of previously available SIA vector. But the AIA vector contains many
zero amounts of chemical species (dependent components) which may be
relevant aqueous species or form stable condensed or fluid phases,
although this is not a priori known. For that reason, the zero mole
amounts in the AIA initial approximation are filled out with a default
amount (1e-7 - 1e-6 mol) which then would increase or decrease upon GEM
iterations depending on the stability of the chemical species in this
chemical system. If the current amount of <span
 style="font-style: italic;">j</span>-th species <span
 style="font-style: italic;">n<sub>j</sub></span> falls below a certain
numerical threshold (ca. 1e-20 mol), it will be zeroed off. This
eliminates the <span style="font-style: italic;">j</span>-th species
from subsequent GEM iterations in order to avoid numerical troubles.
However, if the total amount of a phase falls below another threshold
(Pa_DS between 1e-9 and 1e-12 mol) then all components in this phase
will be zeroed off and the whole phase is eliminated from next GEM
iterations.<br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The fill-out
procedure in AIA bears also a danger that the mass balance is violated.
Hence, a special EFD() algorithm checks the mass balance residuals and
tries to change the largest elements of the AIA vector in such a way
that the mass balance accuracy would be at least satisfactory (i.e.
deviations less than 1e-7 mol). This is usually done in a few
iterations, and then the initial approximation vector is ready for the
main GEM algorithm. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><a
 name="EFD_PROCEDURE"></a>The third step is
to adjust the elements of <span style="font-style: italic;"></span>speciation
vector <span style="font-style: italic;">n</span> to minimize the
total Gibbs energy of the system <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">n</span>) while keeping mass balance
deviations the same or lower as inherited from the EFD() step. This is
the core of IPM-2 algorithm - it approaches the GEM problem using the
duality (Kuhn-Tucker) theorem by introducing Lagrange multipliers <span
 style="font-style: italic;">u<sub>i</sub></span> conjugate to the
elements <span style="font-style: italic;">b<sub>i</sub></span> of the
bulk composition vector. These Lagrange multipliers form the so-called
"dual solution" of the GEM problem (the "primal solution" being the <span
 style="font-style: italic;">n</span> speciation vector). The total
Gibbs energy of the system can be calculated either as <span
 style="font-style: italic;">G</span>(<span style="font-style: italic;">n</span>)
= sum(<span style="font-style: italic;">n<sub>j</sub> v<sub>j</sub></span>)
where <span style="font-style: italic;">v<sub>j</sub></span> = <span
 style="font-style: italic;">f</span>(<span style="font-style: italic;">g</span><sup>o</sup><sub><span
 style="font-style: italic;">j</span></sub>, <span
 style="font-style: italic;">n</span>) is the primal chemical potential
of j-th dependent component., or as <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">b</span>) = sum(<span
 style="font-style: italic;">b<sub>i</sub> u<sub>i</sub></span>).
Towards equilibrium, <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">n</span>) scalar value approaches a
(global) minimum which equals the <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">b</span>) (global) maximum. Hence, the
criterion of convergence can be constructed using any normalized
function of <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">n</span>) - <span
 style="font-style: italic;">G</span>(<span style="font-style: italic;">b</span>)
which is ideally zero, but numerically must be below a small threshold
(for the quadratic Dikin's criterion, DK &lt; Pa_DK = 1e-4).&nbsp; <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Each iteration of
IPM consists of three steps. First, a new dual solution approximation <span
 style="font-style: italic;">u</span> is found by solving with the
Cholesky decomposition method a SLE constructed from the previous
primal solution, stoichiometry matrix and weight multipliers. Next, the
vector of descent direction is found by comparing primal and dual
chemical potentials for each dependent component. Finally, a step
length multiplier is determined from a condition that no new nj value
should break the "feasible domain" of mass balance and metastability
constraints. The new approximation of the <span
 style="font-style: italic;">n</span> speciation vector is found by
incrementing non-zero elements of the old one with a product of the
respective element of the descent direction vector and the scalar step
length. Convergence is usually achieved in 1-10 iterations in the SIA
and 20 to 100 iterations in the simplex AIA case. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The fourth step
is called "phase selection" (implemented in PhaseSelect() function). It
consists in calculation of Karpov's phase stability criteria for each
multi-component phase present in non-zero amount, as well as for each
pure phase, either zeroed off or not. The stability criteria have been
derived from the Karpov-Kuhn-Tucker conditions of equilibrium state
that compare primal and dual estimates of chemical potential for each
component. For any stable component in a stable phase, the value of
such criterion must be close to zero.&nbsp; However, if the initial
approximation was bad, or there were errors in stoichiometry or <span
 style="font-style: italic;">g</span><sup>o</sup> value for a dependent
component, <span style="font-style: italic;"></span> the value of
Karpov's criterion may indicate that a phase present in the mass
balance is unstable and must be excluded, or vice versa - a phase
absent from the mass balance (zeroed off) is stable and must be
included. If any such phase has been detected, it is zeroed off
respectively its component amounts are filled out with small amounts,
and the whole sequence is repeated from Step two (but without the
overall fill-out step). If, after three such refinement loops, the
PhaseSelect() still finds inconsistent phases, the behavior of GEM IPM
algorithm depends on the original initial approximation. If it was SIA,
the mode is automatically switched to AIA and calculation begin "from
scratch", i.e. from solving the LP sub-problem for a generic IA. If it
was AIA, an error message is generated and the GEM solution is not
accepted. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The flow-chart
described above applies when all elements of the bulk composition
vector (except charge) exceed 1e-6 mol. However, if there are some
elements less than 1e-7 mol, the IPM algorithm starting with AIA may
fail with the corresponding mass balance residual which may also be of
the same order of magnitude or even higher (i.e. the mass balance error
may be from 50% to 1000%). The reason for that is the "fill-out" step
spoils the mass balance and the EFD() procedure cannot recover it
completely. In this sutiation, the IPM-2 algorithm is invoked, which in
the case of AIA first runs as the generic IPM algorithm. Even with bad
mass balance precision, this step yields a solution which lies very
close to the <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">n</span>) minimum and can be used as a
very good initial approximation where the fill-out procedure is not
needed (because all stable phases and components are already known) and
the mass balance residuals thresholds in the EFD-2() procedure can be
set at much lower levels, separately for different independent
components. This is the idea of IPM-2 refinement loops: after
convergence of GEM descent and PhaseSelect() check, an additional check
for the fullfillment of severe mass balance requirements is performed.
If there are still some bad residuals, the loop is repeated with just
obtained approximation of the <span style="font-style: italic;">n</span>
vector from the EFD-2() procedure. In most cases, up to 15 such loops
are sufficient to provide a GEM solution with 0.1% maximum mass balance
residual even for the smallest "trace" independent component present in
1e-14 mol total amount. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">A similar
sequence of refinement loops can be applied when two or more non-ideal
solution phases are present near the critical point of their solvus. In
such a system, the difference in molar Gibbs energy of such phases
becomes tiny and up to 20 refinement GEM-IPM2 runs may be required to
obtain correct speciation. Such systems, however, are rare and in
principle cannot be solved with LMA algorithms. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">All these
numerical paths of the iterative GEM IPM-2 algorithm are controlled
through ca. 20 thresholds and flags, values of which were empirically
found in many test and modelling calculations in various systems. These
  <a href="#NUMERICAL_CONTROLS">numerical controls</a> can be adjusted
in GEMS-PSI GUI window or in the <big><span
 style="font-family: monospace;">*ipm.dat</span></big>&nbsp;
input file of GEMIPM2K standalone program, as described in the <a
 href="gemipm2k-inp.html">companion manual</a>. <br>
  <br>
  </p>
  <p>&nbsp;</p>
  <h3><a name="KERNEL"></a>2.2. The GEM-IPM2 Kernel (GEMIPM2K) and its
Work Data
Structure IPM (Multi)<br>
  </h3>
  <p style="font-family: Helvetica,Arial,sans-serif;">The GEMIPM2K
program source code comprises a sub-set of C++ source code files used
in the <a href="http://gems.web.psi.ch">GEMS-PSI package</a>. The
difference between two programs is controlled by a compiler define
key&nbsp; <big><span style="font-family: monospace;">-DGEMIPMPLUGIN</span></big>&nbsp;
which has to be provided in the make- or project file for building any
program that uses GEMIPM2K. The global&nbsp; <big><span
 style="font-family: monospace;">#define GEMIPMPLUGIN</span></big>&nbsp;
in the source code cuts any connection to the GEM-Selektor GUI, its
data object descriptors, and data base functions. In both cases, some
numerical subroutines from <a
 href="http://math.nist.gov/tnt/download.html">NIST JAMA-C++ TNT package</a>
for solving SLE are employed. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Here is the list
of source code files common to both GEMS-PSI and GEMIPM2K programs:<br>
  </p>
  <table border="1" cellpadding="2" cellspacing="2" width="100%">
    <tbody>
      <tr>
        <td style="vertical-align: top;"><span
 style="font-family: Helvetica,Arial,sans-serif;">File name</span><br>
        </td>
        <td style="vertical-align: top;"><span
 style="font-family: Helvetica,Arial,sans-serif;">Comment</span><br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>array.h</big></td>
        <td style="vertical-align: top;">Header and templates for
manipulating data arrays <br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace; font-weight: bold;"><a
 href="../../databr.h"><big>databr.h</big></a></td>
        <td style="vertical-align: top;">Header for the DATABR
input/output data exchange structure of GEMIPM2K<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace; font-weight: bold;"><a
 href="../../datach.h"><big>datach.h</big></a></td>
        <td style="vertical-align: top;">Header for the DATACH input
chemical system definition structure of GEMIPM2K</td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>gdatastream.cpp</big></td>
        <td style="vertical-align: top;">Implementation of file I/O
streams (with account for endianness in binary data files)<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>gdatastream.h</big></td>
        <td style="vertical-align: top;">Header for I/O streams for
file access <br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>gstring.cpp</big></td>
        <td style="vertical-align: top;">Implementation of string
manipulation functions <br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>gstring.h</big></td>
        <td style="vertical-align: top;">Header for the string
manipulation class <br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>io_arrays.cpp</big></td>
        <td style="vertical-align: top;">Implementation of file I/O of
data arrays <br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>io_arrays.h</big></td>
        <td style="vertical-align: top;">Header for the file I/O data
arrays functionality <br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>ipm_chemical.cpp</big></td>
        <td style="vertical-align: top;">Implementation of
chemistry-specific functions from TMulti class used in the GEM IPM
kernel<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>ipm_chemical2.cpp</big></td>
        <td style="vertical-align: top;">Continued<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>ipm_chemical3.cpp</big></td>
        <td style="vertical-align: top;">Calculation of activity
coefficients and respective corrections to chemical potentials in GEM
IPM <br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>ipm_main.cpp</big></td>
        <td style="vertical-align: top;">Implementation of main GEM IPM
descent algorithm <br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>ipm_simplex.cpp</big></td>
        <td style="vertical-align: top;">Implementation of LP
calculations of automatic initial approximation using the modified
simplex method<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>jama_cholesky.h</big></td>
        <td style="vertical-align: top;">File from the NIST TNT
JAMA-C++ linear algebra numerical library<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>jama_lu.h</big></td>
        <td style="vertical-align: top;">File from the NIST TNT
JAMA-C++ linear algebra numerical library</td>
      </tr>
      <tr>
        <td style="font-family: monospace; font-weight: bold;"><a
 href="../../ms_multi.h"><big>ms_multi.h</big></a></td>
        <td style="vertical-align: top;">Main header for the TMulti
class and MULTI data structure keeping data of GEM IPM-2 algorithm<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>ms_multi_file.cpp</big></td>
        <td style="vertical-align: top;">Implementation of GEMIPM2K
file output (text dump file with TMulti data)<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>ms_multi_format.cpp</big></td>
        <td style="vertical-align: top;">Implementation of GEMIPM2K
file I/O (text and binary *ipm files)</td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>node.cpp</big></td>
        <td style="vertical-align: top;">Implementation of GEMIPM2K
TNode class - data exchange interface for coupled codes<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace; font-weight: bold;"><a
 href="../../node.h"><big>node.h</big></a></td>
        <td style="vertical-align: top;">Header for the TNode class
(used in GEMIPM2K and in GEM2MT module of GEMS-PSI)<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>node_format.cpp</big></td>
        <td style="vertical-align: top;">Implementation of GEMIPM2K
file I/O (text and binary *dch and *dbr files)</td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>nodearray.cpp</big></td>
        <td style="vertical-align: top;">Implementation of GEMIPM2K
TNodeArray class - data exchange interface for coupled codes</td>
      </tr>
      <tr>
        <td style="font-family: monospace; font-weight: bold;"><a
 href="../../nodearray.h"><big>nodearray.h</big></a></td>
        <td style="vertical-align: top;">Header for the TNodeArray
class (used in GEMIPM2K and in GEM2MT module of GEMS-PSI)</td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>num_methods.cpp</big></td>
        <td style="vertical-align: top;">Implementation of the internal
numerical&nbsp; solvers used in GEM IPM module <br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>num_methods.h</big></td>
        <td style="vertical-align: top;">Headers for internal 1-D and
2-D Lagrange interpolation function (used in TNode)<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>s_fgl.h</big></td>
        <td style="vertical-align: top;">Headers for built-in non-ideal
fluid and solution models </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>s_fgl.cpp</big></td>
        <td style="vertical-align: top;">Implementation of buil-in
non-ideal fluid and some solid solution models </td>
      </tr>
      <tr>
        <td style="vertical-align: top; font-family: monospace;"><big>s_fgl1.cpp</big></td>
        <td style="vertical-align: top;">Implementation of buil-in
non-ideal fluid and some solid solution models</td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>s_fgl2.cpp</big></td>
        <td style="vertical-align: top;">Implementation of buil-in
non-ideal fluid and some solid solution models</td>
      </tr>
      <tr>
        <td style="vertical-align: top; font-family: monospace;"><big>s_fgl3.cpp</big></td>
        <td style="vertical-align: top;">Implementation of buil-in
non-ideal fluid and some solid solution models</td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>tnt.h</big></td>
        <td style="vertical-align: top;">File from the NIST TNT linear
algebra numerical library</td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>tnt_array1d.h</big></td>
        <td style="vertical-align: top;">File from the NIST TNT linear
algebra numerical library</td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>tnt_array2d.h</big></td>
        <td style="vertical-align: top;">File from the NIST TNT linear
algebra numerical library</td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>tnt_i_refvec.h</big></td>
        <td style="vertical-align: top;">File from the NIST TNT linear
algebra numerical library</td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>v_user.h</big></td>
        <td style="vertical-align: top;">Header containing declarations
of platform-specific utility functions and classes<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>verror.h</big></td>
        <td style="vertical-align: top;">Declarations for error
exceptions handling: classes TError and TFatalError<br>
        </td>
      </tr>
    </tbody>
  </table>
  <p style="font-family: Helvetica,Arial,sans-serif;"><br>
Files necessary for calling GEMIPM2K from coupled codes are shown in
boldface. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Two header files
from GEMIPM2K directory listed below have the same names as in the
GEMS-PSI source code, but different contents. <br>
  </p>
  <table border="1" cellpadding="2" cellspacing="2" width="100%">
    <tbody>
      <tr>
        <td style="font-family: monospace;"><a href="../../m_const.h"><big>m_const.h</big></a></td>
        <td style="vertical-align: top;">Codes and parameters for
components and phases used in GEM IPM-2 work structure (standalone
version)<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><a href="../../m_param.h"><big>m_param.h</big></a></td>
        <td style="vertical-align: top;">Basic codes and numerical
settings used in GEM IPM-2 operation (standalone version)<br>
        </td>
      </tr>
    </tbody>
  </table>
  <p style="font-family: Helvetica,Arial,sans-serif;"><br>
The files below: <br>
  </p>
  <table border="1" cellpadding="2" cellspacing="2" width="100%">
    <tbody>
      <tr>
        <td style="font-family: monospace;"><a href="../../ms_param.cpp"><big>ms_param.cpp
        <br>
        </big></a></td>
        <td style="vertical-align: top;">Default values of constants
and numerical settings of GEM IPM-2 algorithm; implementations of
methods that load data into/from&nbsp; MULTI structure and execute a
single GEM IPM calculation<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><a href="../../main.cpp"><big>main.cpp</big></a></td>
        <td style="vertical-align: top;">Example of using GEMIPM2K for
batch calculations of chemical equilibria<br>
        </td>
      </tr>
    </tbody>
  </table>
  <p style="font-family: Helvetica,Arial,sans-serif;">&nbsp;are
provided only in the GEMIPM2K code. The file&nbsp; <big><span
 style="font-family: monospace;">main.cpp</span></big>&nbsp; is needed
for compiling an example of usage of GEMIPM2K. This file can be changed
according to your tasks. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">There are two
alternative make files, provided for different arcitectures in the
./platforms subdirectory. <br>
  </p>
  <table border="1" cellpadding="2" cellspacing="2" width="100%">
    <tbody>
      <tr>
        <td style="font-family: monospace;"><big>Makefile</big></td>
        <td style="vertical-align: top;">make script for building test
example with file I/O as a standalone executable file <br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>Makefile.lib</big></td>
        <td style="vertical-align: top;">make script for creating a
static library for subsequent linking with other parts of the coupled
FMT-GEM code<br>
        </td>
      </tr>
    </tbody>
  </table>
  <p><big><span style="font-family: monospace;">Makefile</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> is used for building
a static executable file </span><big><span
 style="font-family: monospace;">gemcalc(.exe)</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> for the test
example. <br>
  </span><big><span style="font-family: monospace;">Makefile.lib</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> can be used for
building a static library&nbsp; </span><big><span
 style="font-family: monospace;">gemipm2k.a</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">&nbsp; (or </span><big><span
 style="font-family: monospace;">gemipm2k.lib</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">) which can be linked
to the mass-transport&nbsp; part to produce a coupled code later on.<br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The GEM
IPM-2 algorithm is implemented as a set of C++ functions belonging to
the TMulti class that all use data and lists provided in a single
instance of the&nbsp; MULTI data structure also inserted into the
TMulti class. Before any GEM calculation, all data arrays must be
allocated according to current number of components and phases, and all
input data must be correctly filled into these arrays. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">In the
GEMS-PSI GUI environment, this is done automatically before any GEM
calculation is started. The data of the "internal" GEM problem are
compressed into MULTI data structure by collecting the items from the
project system lists and arrays, as well as from the thermodynamic data
base. In the project system lists, many independent components,
dependent components, and phases may be switched off by the user. Only
the names and data for components and phases that are switched on are
copied into the MULTI structure. If necessary, the scripts for
calculating activity coefficients of components of non-ideal solution
phases are also compressed, together with any needed coefficients for
non-ideal interaction parameters or surface complexation models picked
up from the Phase database records. This makes the GEMS GUI setup of
thermodynamic models very flexible, though rendering its software
implementation rather complicated. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">This route
cannot be followed in the standalone GEMIPM2K program and any programs
using it. The purpose of GEMIPM2K is to keep the code implementation
and handling of I/O data as simple as possible. This is the
prerequisite for compiling the cupled FMT-GEM program on any computer
architecture, up to parallel HPC clusters. Consequently, the GEMIPM2K
program has no GUI, no direct access to thermodynamic data base, and it
has no script interpreter included. It uses only data for a
"compressed" GEM problem thoroughly contained in the MULTI structure
(i.e. no components or phases that were switched off from the lists are
allowed). Because of that, some restrictions apply in GEMIPM2K relative
to GEMS-PSI code: <br>
  </span></p>
  <h4><span style="font-family: Helvetica,Arial,sans-serif;">&nbsp;DIfferences
in functionality between GEMIPM2K program and the full GEMS code<br>
  </span></h4>
  <table style="text-align: left; width: 100%;" border="1"
 cellpadding="2" cellspacing="2">
    <tbody>
      <tr>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Function<br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">GEMIPM2K<br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">GEM-Selektor<br>
        </td>
      </tr>
      <tr>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Phase-
and Process math scripts<br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Not
possible<br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Used<br>
        </td>
      </tr>
      <tr>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Built-in
functions for
activity coefficients<br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Used<br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Used<br>
        </td>
      </tr>
      <tr>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">T-P
corrections for input
thermodynamic data<br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Interpolation
using a lookup array (produced in GEMS)<br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Direct
access to thermodynamic
data base, built-in HKF EoS, CG EoS, PRSV EoS, Cp double integration,
etc.<br>
        </td>
      </tr>
      <tr>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Access
to input, output and
work data<br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Batch
mode only (data exchange I/O files or
in RAM)<br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Direct
GUI access, including
multithread stepwise mode<br>
        </td>
      </tr>
      <tr>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Runtime
help and tooltips <br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Not
available<br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Available
as runtime HTML
help, either local or in internet<br>
        </td>
      </tr>
    </tbody>
  </table>
  <p><span style="font-family: Helvetica,Arial,sans-serif;"><br>
In principle,&nbsp; all the input data required for GEM IPM-2
calculation can be provided in a human-made ASCII file. However,
producing such file without a software front-end that can access the
thermodynamic data base would be a difficult and error-prone
process. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Moreover,
RMT problems are usually represented by many nodes; reactive subsystems
in all these nodes can share the same chemical system definition (CSD)
and would usually differ only in bulk chemical composition (,
temperature and pressure). Hence, it would make no sense to use the
MULTI data structure directly for data exchange with the mass-transport
part. Often, not all independent and dependent components must take
place in exchange with the MT part - only those components that are
somehow transported from node to node. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">For these
reasons, the whole content of the MULTI and BASE_PARAM data structures
required for a GEM IPM-2 calculation has been subdivided into three
main parts, or data sub-sets (covered with the respective I/O files): <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;"></span></p>
  <table style="text-align: left; width: 100%;" border="1"
 cellpadding="2" cellspacing="2">
    <tbody>
      <tr>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">&nbsp;Identifier
of data subset<br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">&nbsp;Data
structure<br>
        </td>
        <td style="vertical-align: top;">&nbsp;<span
 style="font-family: Helvetica,Arial,sans-serif;">Visibility</span> <br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;"><a
 href="#INPUT_FILES">&nbsp;I/O file</a><br>
        </td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">&nbsp;Comment<br>
        </td>
      </tr>
      <tr>
        <td style="vertical-align: top;">DCH<br>
        </td>
        <td style="vertical-align: top;"><a href="../../datach.h"><big><span
 style="font-family: monospace;">DATACH</span></big></a><br>
        </td>
        <td style="vertical-align: top;">GEM and MT parts<br>
        </td>
        <td style="vertical-align: top;">*dch.dat&nbsp; <br>
        </td>
        <td style="vertical-align: top;">Input definition of the
chemical system (compressed) with selection of components and phases to
be exchanged with the mass-transport part common to all nodes of the
RMT problem<br>
        </td>
      </tr>
      <tr>
        <td style="vertical-align: top;">DBR<br>
        </td>
        <td style="vertical-align: top;"><a href="../../databr.h"><big><span
 style="font-family: monospace;">DATABR</span></big></a><br>
        </td>
        <td style="vertical-align: top;">GEM and MT parts<br>
        </td>
        <td style="vertical-align: top;">*dbr.dat&nbsp; <br>
        </td>
        <td style="vertical-align: top;">Data bridge for node-specific
chemical input and output properties (bulk composition, speciation,
temperature, pressure, optional kinetic constraints)<br>
        </td>
      </tr>
      <tr>
        <td style="vertical-align: top;">IPM<br>
        </td>
        <td style="vertical-align: top;"><big><span
 style="font-family: monospace;"><a href="../../ms_multi.h">MULTI</a>, <a
 href="../../m_param.h">BASE_PARAM</a></span></big><br>
        </td>
        <td style="vertical-align: top;">GEM part only<br>
        </td>
        <td style="vertical-align: top;">*ipm.dat&nbsp; <br>
        </td>
        <td style="vertical-align: top;">Input information not relevant
for the MT part, but needed for GEM IPM-2 calculations (numerical
settings, parameters of non-ideal mixing models, adsorption models
etc.) <br>
        </td>
      </tr>
    </tbody>
  </table>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">DCH and DBR
files are automatically (un)packed to/from the MULTI memory structure
inside of the TNode class. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The
advantage of having three kinds of input files instead of one is that
in a typical RMT problem with tens to hundreds of thousands of nodes,
only one
relatively large DCH and one IPM file is needed, while node-specific
data are provided in many small and compact input-output DBR files
without redundant information. As a consequence,&nbsp; higher
performance and flexibility of the coupled code can be achieved. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">In the
current implementation of GEMIPM2K, two file I/O modes are possible:
binary stream and text stream. Binary stream DCH, DBR and IPM files are
simply images of the respective memory data structures; they may be
non-transferable between different computer architectures. The text
stream files are transferable; they have a human-readable format with
tags (keywords) followed with the data; comment lines are possible
anywhere. For most data items, the input order is free; many data
objects can be
skipped if the program can substitute default values.&nbsp; Only&nbsp;
dimenions necessary for internal data allocation must be present at the
beginning of DCH and IPM files. More about the file structure of
GEMIPM2K is provided in <a href="#INPUT_FILES">section 5 of this manual</a>,
as well as in the <a href="gemipm2k-inp.html">companion manual</a>.<br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;"><a
 name="GEMS_GENERATE_INPUT_FILES"></a>In order to
facilitate preparation of GEMIPM2K input files, the GEMS-PSI code has
two ways of generating them automatically.&nbsp; One way is to set up
the chemical system in "Single thermodynamic system" dialog, calculate
equilibrium, and save it into SysEq record (see <a
 href="http://gems.web.psi.ch/screenshots/sshgal01.html">Screenshot
tutorial</a> for details). To produce the GEMIPM2 input files, follow
the <a href="#PRODUCE_FILES_S">instructions here</a>. From the same
GEMS dialog, it is even possible to upload a set of GEMIPM2K files
after GEMIPM2K or coupled code calculations (you must be in the same
modelling project system from which the initial GEMIPM2K files were
generated).&nbsp; In this way, you can conveniently explore results of
GEMIPM2K run for a single system, e.g., after changing manually some
input data in DBR or IPM file. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Another way
to create a set of GEMIPM2K input files for
multiple nodes is to set up a GEM2MT module record of "S" type (see
documentation to GEM2MT, under construction). Re-calculation of such
record results in a collection of one DCH, one IPM and multiple DBR
files sufficient to
set ip initial systems and start a coupled modelling session. </span><br>
  <br style="font-family: Helvetica,Arial,sans-serif;">
  <br>
  </p>
  <h3><a name="DATACH"></a>2.3. <font
 style="font-family: times new roman,times,serif;"
 face="Helvetica, Arial, sans-serif">The DATACH Structure for Chemical
System Definition (CSD)&nbsp;</font> </h3>
  <p style="font-family: Helvetica,Arial,sans-serif;">The <a
 href="../../datach.h"><big><span style="font-family: monospace;">DATACH</span></big></a>&nbsp;
structure (mirrored in a DCH input file) contains an input definition
of the chemical system visible to both GEMIPM2K and mass-transport
parts of a coupled code. The respective dimensions, lists of components
and phases etc. will be automatically copied into the MULTI work data
structure of GEM IPM algorithm upon an initialization of a&nbsp; <big><span
 style="font-family: monospace;"><a href="../../node.h">TNode</a> </span></big>class
instance which includes reading of one DCH, one IPM and at least one
DBR
files. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The<span
 style="font-weight: bold;"> first</span>, CSD part of
DATACH structure includes the following data: <br>
  </p>
  <table style="width: 100%;" border="1" cellpadding="2" cellspacing="2">
    <tbody>
      <tr>
        <td style="font-family: Helvetica,Arial,sans-serif;">Type</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> ID in
DATACH structure<br>
        </td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> ID in
MULTI structure<br>
        </td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> DOD label
in GEMS</td>
        <td style="vertical-align: top;"><span
 style="font-family: Helvetica,Arial,sans-serif;">Label in DCH file</span><br>
        </td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Content</td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;">short</span></td>
        <td style="font-family: monospace;"><big> nIC</big></td>
        <td style="font-family: monospace;"><big> N<br>
        </big></td>
        <td style="font-family: monospace;"><big> <br>
        </big></td>
        <td style="font-family: monospace;"><big>nIC<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Total
number of IC (independent components) <br>
        </td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;"> </span><span
 style="font-family: monospace;">short</span></td>
        <td style="font-family: monospace;"><big> nDC</big></td>
        <td style="font-family: monospace;"><big> L<br>
        </big></td>
        <td style="font-family: monospace;"><big> <br>
        </big></td>
        <td style="font-family: monospace;"><big>nDC<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Total
number of DC (chemical species or dependent components) <br>
        </td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;"> </span><span
 style="font-family: monospace;">short</span></td>
        <td style="font-family: monospace;"><big> nPH</big></td>
        <td style="font-family: monospace;"><big> FI<br>
        </big></td>
        <td style="font-family: monospace;"><big> <br>
        </big></td>
        <td style="font-family: monospace;"><big>nPH<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Total
number of phases included into this CSD</td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;"> </span><span
 style="font-family: monospace;">short</span></td>
        <td style="font-family: monospace;"><big> nPS</big></td>
        <td style="font-family: monospace;"><big> FIs<br>
        </big></td>
        <td style="font-family: monospace;"><big> <br>
        </big></td>
        <td style="font-family: monospace;"><big>nPS<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Number of
multicomponent phases (nPS &lt;=&nbsp; nPH)</td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;"> </span><span
 style="font-family: monospace;">short</span></td>
        <td style="font-family: monospace;"><big> nDCs</big></td>
        <td style="font-family: monospace;"><big> Ls<br>
        </big></td>
        <td style="font-family: monospace;"><big> <br>
        </big></td>
        <td style="font-family: monospace;"><big>nDCs<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Total
Number of DC in phases-solutions</td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;">short</span><span
 style="font-family: monospace;">[]</span></td>
        <td style="font-family: monospace;"><big> nDCinPH</big></td>
        <td style="font-family: monospace;"><big> L1<br>
        </big></td>
        <td style="font-family: monospace;"><big> L1<br>
        </big></td>
        <td style="font-family: monospace;"><big>nDCinPH<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Number of
DC included into each phase [nPH] </td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;">float[]</span></td>
        <td style="font-family: monospace;"><big> A</big></td>
        <td style="font-family: monospace;"><big> A<br>
        </big></td>
        <td style="font-family: monospace;"><big> A<br>
        </big></td>
        <td style="font-family: monospace;"><big>A</big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;">Stoichiometry
matrix A containing amounts of IC in one mole of each DC
[nIC][nDC]<br>
        </td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;">double</span><span
 style="font-family: monospace;">[]</span></td>
        <td style="font-family: monospace;"><big> ICmm</big></td>
        <td style="font-family: monospace;"><big> Awt<br>
        </big></td>
        <td style="font-family: monospace;"><big> icM<br>
        </big></td>
        <td style="font-family: monospace;"><big>ICmm<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> IC atomic
(molar) mass in g/mol [nIC]<br>
        </td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;">double</span><span
 style="font-family: monospace;">[]</span></td>
        <td style="font-family: monospace;"><big> DCmm</big></td>
        <td style="font-family: monospace;"><big> MM<br>
        </big></td>
        <td style="font-family: monospace;"><big> mmDC<br>
        </big></td>
        <td style="font-family: monospace;"><big>DCmm *<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> DC molar
mass in g/mol [nDC]<br>
        </td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;">char*[]</span></td>
        <td style="font-family: monospace;"><big> ICNL</big></td>
        <td style="font-family: monospace;"><big> SB<br>
        </big></td>
        <td style="font-family: monospace;"><big> ICnam<br>
        </big></td>
        <td style="font-family: monospace;"><big>ICNL<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> List of
IC names, [nIC] strings of MaxICN
length</td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;">char*[]</span></td>
        <td style="font-family: monospace;"><big> DCNL</big></td>
        <td style="font-family: monospace;"><big> SM<br>
        </big></td>
        <td style="font-family: monospace;"><big> DCnam<br>
        </big></td>
        <td style="font-family: monospace;"><big>DCNL<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> List of
DC names, [nDC] strings of MaxDCN
length</td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;">char*[]</span></td>
        <td style="font-family: monospace;"><big> PHNL</big></td>
        <td style="font-family: monospace;"><big> SF<br>
        </big></td>
        <td style="font-family: monospace;"><big> PHnam<br>
        </big></td>
        <td style="font-family: monospace;"><big>PHNL<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> List of
names of phases, [nPH] strings of
MaxPHN length</td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;">char[]</span></td>
        <td style="font-family: monospace;"><big> ccIC</big></td>
        <td style="font-family: monospace;"><big> ICC<br>
        </big></td>
        <td style="font-family: monospace;"><big> <br>
        </big></td>
        <td style="font-family: monospace;"><big>ccIC<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Class
codes of IC [nIC], see codes in enum ICL_CLASSES<br>
        </td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;">char[]</span></td>
        <td style="font-family: monospace;"><big> ccDC</big></td>
        <td style="font-family: monospace;"><big> DCC<br>
        </big></td>
        <td style="font-family: monospace;"><big> DCC<br>
        </big></td>
        <td style="font-family: monospace;"><big>ccDC<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Class
codes of DC [nDC], see codes in enum DCL_CLASSES<br>
        </td>
      </tr>
      <tr>
        <td><span style="font-family: monospace;">char[]</span></td>
        <td style="font-family: monospace;"><big> ccPH</big></td>
        <td style="font-family: monospace;"><big> PHC<br>
        </big></td>
        <td style="font-family: monospace;"><big> <br>
        </big></td>
        <td style="font-family: monospace;"><big>ccPH<br>
        </big></td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Class
codes of phases [nPH], see codes in enum PHL_CLASSES <br>
        </td>
      </tr>
    </tbody>
  </table>
  <p style="font-family: Helvetica,Arial,sans-serif;">* since version
2.2.3, <big><span style="font-family: monospace;">DCmm</span></big>
vector is automatically calculated from <big><span
 style="font-family: monospace;">A</span></big> and <big><span
 style="font-family: monospace;">ICmm</span></big> and can be skipped
from the DCH file<br>
  <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Because direct
access to GEMS thermodynamic data base is not possible and functions
for <span style="font-style: italic;">T,P</span> corrections of
thermodynamic data&nbsp; are not available in
GEMIPM2K, the retrieval of thermodynamic data for dependent components
is implemented through the interpolation from look-up arrays provided
in the DATACH structure and file. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">This <span
 style="font-weight: bold;">second</span> part of DATACH includes the
following
data: <br>
  </p>
  <table style="width: 100%;" border="1" cellpadding="2" cellspacing="2">
    <tbody>
      <tr>
        <td style="font-family: Helvetica,Arial,sans-serif;">Type</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> ID</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Dimensions</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Comment</td>
        <td style="vertical-align: top;"><span
 style="font-family: Helvetica,Arial,sans-serif;">Label in DCH file</span><br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>short</big></td>
        <td style="font-family: monospace;"><big> nTp</big></td>
        <td style="font-family: monospace;"><big> 1<br>
        </big></td>
        <td> Number of temperature points in lookup grid arrays<br>
        </td>
        <td style="font-family: monospace;"><big>nTp<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>short</big></td>
        <td style="font-family: monospace;"><big> nPp</big></td>
        <td style="font-family: monospace;"><big> 1<br>
        </big></td>
        <td> Number of pressure points in lookup grid arrays <br>
        </td>
        <td style="font-family: monospace;"><big>nPp<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>short</big></td>
        <td style="font-family: monospace;"><big> iGrd</big></td>
        <td style="font-family: monospace;"><big> 1<br>
        </big></td>
        <td> Flag for lookup grid array setup: 0 - only V0 and G0; 1
- plus H0; 2 - plus S0; 3 - plus Cp0; 4 - plus A0 (Helmholtz); -1 - V0,
G0 and DD (modes 1,2,3,4,-1 reserved)</td>
        <td style="font-family: monospace;"><big>iGrd<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>float[]</big></td>
        <td style="font-family: monospace;"><big> TCval</big></td>
        <td style="font-family: monospace;"><big> nTp</big></td>
        <td>[nTp] discrete values of temperature <span
 style="font-style: italic;">T</span>, in C,&nbsp; in ascending order<br>
        </td>
        <td style="font-family: monospace;"><big>TCval<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>float[]</big></td>
        <td style="font-family: monospace;"><big> Pval</big></td>
        <td style="font-family: monospace;"><big> nPp</big></td>
        <td>[nPp] discrete values of pressure <span
 style="font-style: italic;">P</span>, in bars,&nbsp; in ascending order<br>
        </td>
        <td style="font-family: monospace;"><big>Pval<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>double</big></td>
        <td style="font-family: monospace;"><big> Ttol</big></td>
        <td style="font-family: monospace;"><big> 1<br>
        </big></td>
        <td> Temperature tolerance, in K, for the interpolation of
thermodynamic data (default: 0.1)<br>
        </td>
        <td style="font-family: monospace;"><big>Ttol<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>double</big></td>
        <td style="font-family: monospace;"><big> Ptol</big></td>
        <td style="font-family: monospace;"><big> 1<br>
        </big></td>
        <td> Pressure tolerance, in bars, for the interpolation of
thermodynamic data (default: 1.0)<br>
        </td>
        <td style="font-family: monospace;"><big>Ptol<br>
        </big></td>
      </tr>
    </tbody>
  </table>
  <p style="font-family: Helvetica,Arial,sans-serif;"><br>
The<big><span style="font-family: monospace;"> iGrd</span></big> flag
defines which
thermodynamic data must be considered (and provided as lookup grid
arrays in the DCH file). In the default case (<big><span
 style="font-family: monospace;">iGrd = 0</span></big>),&nbsp; only
molar volumes <span style="font-style: italic;">V</span><sup>o</sup>
and molar Gibbs energies of chemical species <span
 style="font-style: italic;">G</span><sup>o</sup> are provided and used
(see table below). If the aqueous phase is included in the chemical
system then also the density <big><span style="font-family: monospace;">roW</span></big>
and dielectric constant <big><span style="font-family: monospace;">epsW</span></big>
of water must be provided. With this setup, coupled reactive mass
transport calculations based on calculations of isobaric-isothermal
chemical equilibria can be performed. Complete THMC coupled modeling
cases require usage of other <big><span style="font-family: monospace;"></span></big>setups
with more thermodynamic data, e.g. indicated by&nbsp; <big><span
 style="font-family: monospace;">iGrd</span></big> = 1, 2, 3 or 4.
These
setups will be completed and tested in future versions of GEMIPM2K
(since 2.3).&nbsp; <br>
  </p>
  <table border="1" cellpadding="2" cellspacing="2" width="100%">
    <tbody>
      <tr>
        <td style="font-family: Helvetica,Arial,sans-serif;">Type</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> ID</td>
        <td style="font-family: Helvetica,Arial,sans-serif;">Dimensions</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> comment</td>
        <td style="vertical-align: top;">Label in DCH file<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>double[]<br>
        </big></td>
        <td style="font-family: monospace;"><big> roW</big></td>
        <td style="font-family: monospace;"> [nPp][nTp] </td>
        <td> Density of water-solvent, g/cm3 <br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>roW<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>double[]<br>
        </big></td>
        <td style="font-family: monospace;"><big> epsW</big></td>
        <td style="font-family: monospace;"> [nPp][nTp]</td>
        <td> Dielectric constant of water-solvent, relative</td>
        <td style="vertical-align: top; font-family: monospace;"><big>epsW<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>double[]<br>
        </big></td>
        <td style="font-family: monospace;"><big> G0</big></td>
        <td style="font-family: monospace;"> [nDC][nPp][nTp] </td>
        <td> Go standard molar Gibbs energy of DC, J/mol, corrected to <span
 style="font-style: italic;">T,P</span><br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>G0<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>double[]<br>
        </big></td>
        <td style="font-family: monospace;"><big> V0</big></td>
        <td style="font-family: monospace;"> [nDC][nPp][nTp]</td>
        <td> Vo standard molar volume of DC, J/bar, corrected to <span
 style="font-style: italic;">T,P</span></td>
        <td style="vertical-align: top; font-family: monospace;"><big>V0<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>double[]<br>
        </big></td>
        <td style="font-family: monospace;"><big> S0</big></td>
        <td style="font-family: monospace;"> [nDC][nPp][nTp]</td>
        <td>So standard molar entropy of DC, J/K/mol, corrected to <span
 style="font-style: italic;">T,P</span> (reserved)<br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>S0<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>double[]<br>
        </big></td>
        <td style="font-family: monospace;"><big> H0</big></td>
        <td style="font-family: monospace;"> [nDC][nPp][nTp]</td>
        <td> Ho standard molar enthalpy of DC, J/mol, corrected to <span
 style="font-style: italic;">T,P</span>, (reserved) <br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>H0<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>double[]<br>
        </big></td>
        <td style="font-family: monospace;"><big> Cp0</big></td>
        <td style="font-family: monospace;"> [nDC][nPp][nTp] </td>
        <td> Cpo molar heat capacity of DC J/K/mol, corrected to <span
 style="font-style: italic;">T,P</span> (reserved)<br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>Cp0<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>double[]<br>
        </big></td>
        <td style="font-family: monospace;"><big> DD</big></td>
        <td style="font-family: monospace;"> [nDC][nPp][nTp]</td>
        <td> Diffusition coefficients for
aqueous species (now constant, reserved) <span
 style="background-color: rgb(255, 255, 153);">units?</span><br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>DD<br>
        </big></td>
      </tr>
    </tbody>
  </table>
  <p style="font-family: Helvetica,Arial,sans-serif;"><br>
Implementation of this functionality is located in the <big><span
 style="font-family: monospace;">ms_param.cpp</span></big>
(GEMIPM2K-specific variant of <big><span
 style="font-family: monospace;">TMulti::CompG0Load()</span></big>
function), <big><span style="font-family: monospace;">num_methods.cpp</span></big>
(<big><span style="font-family: monospace;">LagranInterp()</span></big>
function, and <big><span style="font-family: monospace;">node.cpp</span></big>
(<big><span style="font-family: monospace;">TNode::check_grid_TP()</span></big>
function)) files. In addition, the <big><span
 style="font-family: monospace;">TNode</span></big> class provides
methods for accessing interpolated thermodynamic data from the
mass-transport part at any time through the <big><span
 style="font-family: monospace;">DATACH</span></big> memory structure (<big><span
 style="font-family: monospace;">TNode::DC_G0_TP()</span></big>, <big><span
 style="font-family: monospace;">TNode::DC_V0_TP()</span></big>,
etc.)&nbsp; <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The trivial case
of lookup is when <big><span style="font-family: monospace;">nTp</span></big>
= 1 and <big><span style="font-family: monospace;">nPp</span></big> =
1 (0-D interpolation). In this case, each thermodynamic data array (see
the table below) must contain one
value per DC for a single temperature <big><span
 style="font-family: monospace;">TCval[0]</span></big> and pressure <big><span
 style="font-family: monospace;">Pval[0]</span></big>. Conversely, no
variations in <span style="font-style: italic;">T,P</span> between the
nodes or with
time will then be allowed in the coupled model. Actually, the program
checks that current <span style="font-style: italic;">T</span> and <span
 style="font-style: italic;">P</span> coincide with a value from <big><span
 style="font-family: monospace;">TCval </span></big>resp. <big><span
 style="font-family: monospace;">Pval</span><span
 style="font-family: monospace;"></span></big> within the tolerance
limits given in <big><span style="font-family: monospace;"></span><span
 style="font-family: monospace;">Ttol</span></big> and <big><span
 style="font-family: monospace;">Ptol</span></big>, respectively, and
picks up the values from grid arrays.&nbsp; <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The more common
case is when the pressure is fixed (<big><span
 style="font-family: monospace;">nPp</span></big> =
1) but the temperature in the nodes is allowed to change (e.g. <big><span
 style="font-family: monospace;">nTp</span></big>=
8). Then the <big><span style="font-family: monospace;">Pval</span></big>
array must contain a single value of pressure (e.g.
10 bar) and the <big><span style="font-family: monospace;">Tval</span></big>
array - 8 values of temperature in ascending order
(e.g. 5, 25, 45, 65, 85, 105, 125, 145 <sup>o</sup>C). These values
define the overall temperature interval
{4.9; 145.1 <sup>o</sup>C}. The differences between adjacent
temperature values
must not
necessarily be equal. According to this setup, the <big><span
 style="font-family: monospace;">roW</span></big> and <big><span
 style="font-family: monospace;">EpsW</span></big> arrays
must contain 8 values each that correspond to 10 bar pressure and the
temperatures given in <big><span style="font-family: monospace;">Tval</span></big>
array. Provided that there are 40 dependent
components in the DCH list, the <big><span
 style="font-family: monospace;">G0</span></big> array will consist of
8 values per
DC, i.e. total 320 numbers, the first 8 contain <span
 style="font-style: italic;">G</span><sup>o</sup> values for the first
species (for temperatures in <big><span style="font-family: monospace;">Tval</span></big>),
next 8 values - for the second
species, and so on. The <big><span style="font-family: monospace;">V0</span></big>
array should be organized likewise. The
interpolation subroutine looks then separately for each dependent
component to return <span style="font-style: italic;">G</span><sup>o</sup>
and <span style="font-style: italic;">V</span><sup>o</sup> values for <span
 style="font-style: italic;">P</span>=10 bar and <span
 style="font-style: italic;">T</span> of interest,
interpolated in 1-D mode, if necessary. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">In the most
general
case, the lookup grid arrays contain numbers for several discrete
pressures and several discrete temperatures. Then the <big><span
 style="font-family: monospace;">roW</span></big> and <big><span
 style="font-family: monospace;">epsW</span></big>
arrays are actually&nbsp; tables made of rows each containing values
for different
temperatures from <big><span style="font-family: monospace;">Tval</span></big>
but one pressure value from <big><span style="font-family: monospace;">Pval</span></big>.
The <big><span style="font-family: monospace;">G0 </span></big>and <big><span
 style="font-family: monospace;">V0</span></big>
arrays are then composed of such tables for each dependent component,
arranged in the order in which the dependent components are listed in
the DATACH <big><span style="font-family: monospace;">DCNL</span></big>
list. The interpolation subroutine performs 2-D interpolation
separately for each dependent component to return its <span
 style="font-style: italic;">G</span><sup>o</sup> and <span
 style="font-style: italic;">V</span><sup>o</sup> values
for <span style="font-style: italic;">P,T</span> of interest.&nbsp;
&nbsp; </p>
  <span style="font-family: Helvetica,Arial,sans-serif;">Thus, the
lookup grid
arrays of thermodynamic data permit GEMIPM2K to extract thermodynamic
data for any current <span style="font-style: italic;">T</span> and <span
 style="font-style: italic;">P</span> in any node, provided that <span
 style="font-style: italic;">T</span> and <span
 style="font-style: italic;">P</span> are
within the respective ranges set in </span><big><span
 style="font-family: monospace;">TCval</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> and </span><big><span
 style="font-family: monospace;">Pval</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> lists. </span><span
 style="font-family: Helvetica,Arial,sans-serif;">Before calling the
GEM IPM-2
calculation, </span><span
 style="font-family: Helvetica,Arial,sans-serif;">the
interpolation is performed, and <span style="font-style: italic;">G</span><sup>o</sup>
and <span style="font-style: italic;">V</span><sup>o</sup> values are
loaded directly into the MULTI
structure, where they remain as long as the input <span
 style="font-style: italic;">P</span> and <span
 style="font-style: italic;">T</span> do not
change. New
interpolation is done when the requested <span
 style="font-style: italic;">P</span> or <span
 style="font-style: italic;">T</span> differ from previous values by
more
than </span><big><span style="font-family: monospace;">Ptol</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">, </span><big><span
 style="font-family: monospace;">Ttol</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">. </span><br>
  <p style="font-family: Helvetica,Arial,sans-serif;"><a
 name="INDEX_MAPPING"></a>The <span style="font-weight: bold;">third</span>
part of the DATACH structure (and file) defines the selection of
components and phases to be exchanged with the mass-transport part via
DATABR structure instances for nodes, or via DBR files. This part
includes the
following data items: <br>
  </p>
  <table border="1" cellpadding="2" cellspacing="2" width="100%">
    <tbody>
      <tr>
        <td style="font-family: Helvetica,Arial,sans-serif;">Type</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> ID</td>
        <td style="font-family: Helvetica,Arial,sans-serif;">Dimensions</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Comment</td>
        <td
 style="vertical-align: top; font-family: Helvetica,Arial,sans-serif;">Label
in DCH file<br>
        </td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>short</big></td>
        <td style="font-family: monospace;"><big> nICb</big></td>
        <td style="font-family: monospace;"> 1<br>
        </td>
        <td> Number of IC (stoichiometry units) (&lt;= nIC) used in
DATABR<br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>nICb<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>short</big></td>
        <td style="font-family: monospace;"><big> nDCb</big></td>
        <td style="font-family: monospace;"> 1<br>
        </td>
        <td> Number of DC (chemical species) &lt;= nDC) used in DATABR<br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>nDCb<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>short</big></td>
        <td style="font-family: monospace;"><big> nPHb</big></td>
        <td style="font-family: monospace;"> 1<br>
        </td>
        <td> Number of Phases (&lt;= nPH) used in DATABR<br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>nPHb<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>short</big></td>
        <td style="font-family: monospace;"><big> nPSb</big></td>
        <td style="font-family: monospace;"> 1<br>
        </td>
        <td> Number of Phases-solutions (&lt;= nPS) used in DATABR<br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>nPSb<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>short</big></td>
        <td style="font-family: monospace;"><big> nAalp</big></td>
        <td style="font-family: monospace;"> 1<br>
        </td>
        <td> Flag for considering surface areas of phases in DATABR<br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>nAalp<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>short[]</big></td>
        <td style="font-family: monospace;"><big> xIC</big></td>
        <td style="font-family: monospace;"> [nICb]</td>
        <td>index mapping list for ICs used in DATABR data vectors <br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>xIC<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>short[]</big></td>
        <td style="font-family: monospace;"><big> xDC</big></td>
        <td style="font-family: monospace;"> [nDCb]</td>
        <td>index mapping list for DCs used in DATABR data vectors <br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>xDC<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big>short[]</big></td>
        <td style="font-family: monospace;"><big> xPH</big></td>
        <td style="font-family: monospace;"> [nPHb]</td>
        <td>index mapping list for phases used in DATABR data vectors <br>
        </td>
        <td style="vertical-align: top; font-family: monospace;"><big>xPH<br>
        </big></td>
      </tr>
    </tbody>
  </table>
  <p style="font-family: Helvetica,Arial,sans-serif;">The trivial
(default) case is when <big> <span style="font-family: monospace;">nICb
= nIC,</span></big><big><span style="font-family: monospace;">nDCb =
nDC, </span></big><big><span style="font-family: monospace;">nPHb =
nPH, </span></big><big><span style="font-family: monospace;">nPSb =
nPS.<span style="font-family: Helvetica,Arial,sans-serif;">In this
case, the data vectors in DATABR structure exactly map the
corresponding data vectors in DATACH and MULTI structures. For
instance, the bulk chemical composition of the system - vector </span><span
 style="font-family: monospace;">b</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> in MULTI - is the
same as the vector </span><span style="font-family: monospace;">bIC</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> provided in the
DATABR structure or DBR file. The index one-to-one mapping lists </span><span
 style="font-family: monospace;">xIC, xDC</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> and </span><span
 style="font-family: monospace;">xPH</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> will also be
trivial. For instance, given 7 independent components in the system (</span><span
 style="font-family: monospace;">nIC</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> = 7), the </span><span
 style="font-family: monospace;">xIC</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> array will simply
contain ascending indexes (</span><span style="font-family: monospace;">0,1,2,3,4,5,6</span><span
 style="font-family: Helvetica,Arial,sans-serif;">). <br>
  </span></span></big></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><big><span
 style="font-family: monospace;"><span
 style="font-family: Helvetica,Arial,sans-serif;">However, the usage of
index mapping lists&nbsp; </span></span></big><big><span
 style="font-family: monospace;"><span style="font-family: monospace;">xIC,xDC</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> and </span><span
 style="font-family: monospace;">xPH</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> </span></span></big><big><span
 style="font-family: monospace;"><span
 style="font-family: Helvetica,Arial,sans-serif;">may&nbsp;
significantly accelerate data exchange and reduce memory size of the
coupled FMT-GEM problem when some ICs, DCs and phases are not
considered in transport between the nodes. For example, the
break-through columns
in experiments are often filled with quartz sand, dissolution of which
can be neglected, so the transport of dissolved silica can also be
neglected.&nbsp; For a system involving calcium and magnesium,
carbonate, and chloride, the&nbsp; DATACH lists in this case will look
like:<br>
  </span></span></big></p>
  <p style="font-family: Helvetica,Arial,sans-serif; margin-left: 40px;"><big><span
 style="font-family: monospace;"><span style="font-family: monospace;">&lt;nIC&gt;
8&nbsp;&nbsp; &lt;nDC&gt; 27&nbsp;&nbsp; &lt;nPH&gt; 8&nbsp;&nbsp;
&lt;nPS&gt; 2<br>
&lt;ICNL&gt;</span><span
 style="font-family: Helvetica,Arial,sans-serif;">&nbsp; </span><span
 style="font-family: monospace;">'C' 'Ca' 'Cl' 'H' 'Mg' 'O' <span
 style="color: rgb(204, 0, 0);">'Si'</span> <span
 style="color: rgb(204, 0, 0);">'Zz'</span></span><span
 style="font-family: Helvetica,Arial,sans-serif;"> &nbsp;&nbsp; ( NB: </span><span
 style="font-family: monospace;">'Zz'</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> stays for electrical
charge). <br>
  </span><span style="font-family: monospace;">&lt;DCNL&gt;</span><span
 style="font-family: Helvetica,Arial,sans-serif;">&nbsp; </span><span
 style="font-family: monospace;">'Ca+2' 'CaOH+' <span
 style="color: rgb(204, 0, 0);">'Ca(HSiO3)+'</span> <span
 style="color: rgb(204, 0, 0);">'CaSiO3@'</span> 'Mg+2' 'MgOH+' <span
 style="color: rgb(204, 0, 0);">'HSiO3-' 'SiO2@' 'SiO3-2'</span> 'CO2@'
'CO3-2' 'HCO3-' <span style="color: rgb(153, 51, 153);">'CH4@'</span>
'Cl-' 'H2@' 'O2@' 'OH-' 'H+' 'H2O@' <span
 style="color: rgb(204, 0, 0);">'H2' 'O2'</span> <span
 style="color: rgb(153, 51, 153);">'Gr'</span> 'Cal' 'Dis-Dol' <span
 style="color: rgb(153, 51, 153);">'Portlandite' 'Brc'</span> <span
 style="color: rgb(204, 0, 0);">'Qtz'</span></span><span
 style="font-family: Helvetica,Arial,sans-serif;">. <br>
  </span><span style="font-family: monospace;">&lt;PHNL&gt;</span><span
 style="font-family: Helvetica,Arial,sans-serif;">&nbsp;</span><span
 style="font-family: monospace;"> 'aq_gen' <span
 style="color: rgb(204, 0, 0);">'gas_gen'</span> <span
 style="color: rgb(153, 51, 153);">'Graphite'</span> 'Calcite'
'Dolomite-dis' <span style="color: rgb(153, 51, 153);">'Portlandite'
'Brucite'</span><span style="color: rgb(204, 0, 0);"> 'Quartz'</span></span><span
 style="font-family: Helvetica,Arial,sans-serif;"><br>
  </span><span style="font-family: monospace;">&lt;nDCinPH&gt;</span><span
 style="font-family: Helvetica,Arial,sans-serif;">&nbsp; </span><span
 style="font-family: monospace;">19 2 1 1 1 1 1 1</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> <br>
  </span></span></big></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><big><span
 style="font-family: monospace;"><span
 style="font-family: Helvetica,Arial,sans-serif;">Now, suppose that our
mass transport model does not consider the transport of gas phase,
electric charge, and of dissolved silicium species (non-transported
components and species are marked red in the lists above). Some
aqueous species and solids are very unlikely to appear </span></span></big><big><span
 style="font-family: monospace;"><span
 style="font-family: Helvetica,Arial,sans-serif;">(marked in pink)</span></span></big><big><span
 style="font-family: monospace;"><span
 style="font-family: Helvetica,Arial,sans-serif;"> and thus
can also be considered irrelevant for the MT model . Then&nbsp;
the&nbsp; respective arrays of the DATABR structure can be made
smaller, and values in them re-mapped to DATACH or MULTI structure as
follows: <br>
  </span></span></big></p>
  <p style="font-family: Helvetica,Arial,sans-serif; margin-left: 40px;"><big><span
 style="font-family: monospace;"><span style="font-family: monospace;">&lt;nICb&gt;
6 &nbsp; &lt;nDCb&gt; 15 &nbsp; &lt;nPHb&gt; 3 &nbsp; &lt;nPSb&gt; 1<br>
&lt;xIC&gt;&nbsp; 0 1 2 3 4 5 <br>
&lt;xDC&gt;&nbsp; 0 1&nbsp; 4 5&nbsp; 9 10 11&nbsp; 13 14 15 16 17
18&nbsp; 22 23 <br>
&lt;xPH&gt;&nbsp; 0&nbsp; 3 4 <br>
  </span></span></big></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><big><span
 style="font-family: monospace;"><span
 style="font-family: Helvetica,Arial,sans-serif;">It is very important
to realize that the re-mapping does not affect any dimensions in the
MULTI structure and any DATACH lists and arrays (the latter remain
accessible in full also to the transport part of the coupled code).
Values for components and phases marked red (non-transported) are
skipped only from data arrays in all instances of the DATABR structure,
but
these components and phases are still present in DATACH and MULTI
structures and take part in the equilibration. In the above example,
the size of a DATABR instance (and DBR file) becomes more than 30% less
compared with the trivial (complete) index mapping case.&nbsp; This
decrease can be even more dramatic for some transport algorithms where
only a certain tracers move, or where the advection strongly prevails
over the diffusion. In the latter case, only the bulk aqueous solution
is migrated as the whole between the nodes, so all dependent components
of the aqueous phase can be skipped from the DATABR mapping. In the
above example, this would make the DATABR instance ca. 3-4 times
smaller
than in the trivial mapping case. <br>
  </span></span></big></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><big><span
 style="font-family: monospace;"><span
 style="font-family: Helvetica,Arial,sans-serif;">It can be stated that
the presence of DATABR index mapping to DATACH structure provides a
great flexibility in defining various coupling schemes between the FMT
and the GEM parts. A natural question is - how the bulk composition of
the node system can be set up when the mapping list </span><span
 style="font-family: monospace;">xIC</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> is incomplete?&nbsp;
A straightforward answer is - the full </span><span
 style="font-family: monospace;">b</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> vector can always be
provided in the IPM file (from where it is directly loaded into the
MULTI structure). The </span><span style="font-family: monospace;">TNode</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> class also has
methods for the direct access to the </span><span
 style="font-family: monospace;">b</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> vector using the
DATACH/MULTI indexation, which can be used e.g. for setting in all
nodes the initial amounts of ICs skipped from the DATABR index mapping.
Use of this functionality makes sense in 2-D or 3-D FMT problems with
relatively large chemical system definition, where it may result in
considerably less memory demand and higher performance of data
exchange. However, the use of SIA initial approximation mode of GEM
IPM2 may be restricted in this case. Hence, for 1-D columns, we
recommend
using the trivial (complete) one-to-one mapping in DATABR and DBR
files. </span></span></big></p>
  <br>
  <p> </p>
  <h3><a name="DATABR"></a>2.4. <font
 face="Helvetica, Arial, sans-serif"><span
 style="font-family: times new roman,times,serif;">The DATABR Structure
for the Node Data Bridge Composition and Speciation data</span> </font>
  </h3>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">This data
structure relies on dimensions provided in the DATACH structure. Hence,
the DCH file must always be read before DBR file(s) in order to
initialize the MULTI and DATABR structures and perform dynamic memory
allocation. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The DATABR
structure contains several flags and three blocks of data. In the
following tables, four columns are provided to indicate which data
fields are set in DATABR by the mass transport part (MT-DB); which are
given from DATABR instance to GEM as input data (DB-GEM); which data is
taken from GEM to DATABR as GEM output (GEM-DB); and which are taken
from DATABR instance to MT part data structures (DB-MT). The most
important GEM input and output data are shown in boldface. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">1. Chemical
scalar variables (all double floating point numbers)</span>. <span
 style="font-family: Helvetica,Arial,sans-serif;">Data for the inert
sub-system are not included in GEM IPM-2 calculations and serve for
completeness of node-related information used by the MT part (mainly on
TNodeArray level).</span> <br>
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;"></span><span
 style="font-family: monospace;"></span></p>
  <table style="width: 891px; height: 395px;" border="1" cellpadding="2"
 cellspacing="2">
    <tbody>
      <tr>
        <td style="font-family: Helvetica,Arial,sans-serif;">ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <br>
        </td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Comment</td>
        <td style="vertical-align: top;"><span
 style="font-family: Helvetica,Arial,sans-serif;">Default</span><br>
        </td>
        <td
 style="font-family: Helvetica,Arial,sans-serif; text-align: center;">MT-DB</td>
        <td
 style="font-family: Helvetica,Arial,sans-serif; text-align: center;">DB-GEM</td>
        <td
 style="font-family: Helvetica,Arial,sans-serif; text-align: center;">GEM-DB</td>
        <td
 style="font-family: Helvetica,Arial,sans-serif; text-align: center;">DB-MT</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Label in
DBR file</td>
      </tr>
      <tr>
        <td style="font-weight: bold;"><big><span
 style="font-family: monospace;">TC</span></big></td>
        <td> Temperature T,
C</td>
        <td style="vertical-align: top;">25<br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace;"><big>TC<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-weight: bold;"><big><span
 style="font-family: monospace;"> P</span></big></td>
        <td> Pressure P,
bar</td>
        <td style="vertical-align: top;">1<br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace;"><big>P<br>
        </big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> Vs</span></big></td>
        <td> Volume V of reactive subsystem,
cm3</td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big>+</big></td>
        <td style="font-family: monospace; text-align: center;"><big>(+)</big></td>
        <td style="font-family: monospace; text-align: center;"><big>(+)</big></td>
        <td style="font-family: monospace; text-align: center;"><big>+</big></td>
        <td style="font-family: monospace;"><big>Vs<br>
        </big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> Vi</span></big></td>
        <td> Volume of inert subsystem,
cm3</td>
        <td style="vertical-align: top;">0<br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace;"><big>Vi<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-weight: bold;"><big><span
 style="font-family: monospace;"> Ms</span></big></td>
        <td> Mass M of reactive subsystem,
g</td>
        <td style="vertical-align: top;">0<br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace; text-align: center;"><big>(+)</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace;"><big>Ms<br>
        </big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> Mi</span></big></td>
        <td> Mass of inert subsystem,
g</td>
        <td style="vertical-align: top;">0<br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace;"><big>Mi<br>
        </big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> Gs</span></big></td>
        <td> Gibbs energy of reactive subsystem,
J</td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big>(+)</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace;"><big>Gs<br>
        </big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> Hs</span></big></td>
        <td> Enthalpy of reactive subsystem,
J (reserved)<br>
        </td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big>(+)</big></td>
        <td style="font-family: monospace; text-align: center;"><big>+</big></td>
        <td style="font-family: monospace;"><big>Hs<br>
        </big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> Hi</span></big></td>
        <td> Enthalpy of inert subsystem,
J</td>
        <td style="vertical-align: top;">0<br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace;"><big>Hi<br>
        </big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> IC</span></big></td>
        <td> Effective aqueous ionic strength, molal</td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace;"><big>IC<br>
        </big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> pH</span></big></td>
        <td> pH of aqueous solution (-log10
molal)</td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace;"><big>pH<br>
        </big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> pe</span></big></td>
        <td> pe (redox) of aqueous solution (-log10
molal)</td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace;"><big>pe<br>
        </big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> Eh</span></big></td>
        <td> Eh (redox) of aqueous solution
V</td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> -</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace; text-align: center;"><big> +</big></td>
        <td style="font-family: monospace;"><big>Eh<br>
        </big></td>
      </tr>
    </tbody>
  </table>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Symbols in
parenthesis (+) indicate data items that are automatically scaled when
loaded from DATABR instance into MULTI structure by multiplying by a
specific storage coefficient </span><big><span
 style="font-family: monospace;">S</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">, or scaled back by
dividing with </span><big><span style="font-family: monospace;">S</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> when extracted from
MULTI to DATABR instance (valid from GEMIPM2K v.2.3.0). Only extensive
properties are re-scaled if </span><big><span
 style="font-family: monospace;">S</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> not equals 1. </span><br>
  </p>
  <p><br>
  <span style="font-family: Helvetica,Arial,sans-serif;">2. Chemical
arrays for the reactive sub-system (all double* C++ type). Values of </span><big><span
 style="font-family: monospace;">nICb,nDCb,nPHb</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> and </span><big><span
 style="font-family: monospace;">nPSb</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> can be found in the
DATACH instance (or DCH file). Access to all arrays in DATABR instance
requires the usage of DATACH <a href="#INDEX_MAPPING">index mapping</a>
lists&nbsp; </span><big><span style="font-family: monospace;">xIC,xDC</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> and </span><big><span
 style="font-family: monospace;">xPH</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">. </span><br>
  <span style="font-family: monospace;"></span></p>
  <table style="width: 100%;" border="1" cellpadding="2" cellspacing="2">
    <tbody>
      <tr>
        <td style="font-family: Helvetica,Arial,sans-serif;">ID</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Dimensions</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Comment</td>
        <td
 style="vertical-align: middle; font-family: Helvetica,Arial,sans-serif;">Default<br>
        </td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> MT-DB</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> DB-GEM</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> GEM-DB</td>
        <td style="font-family: Helvetica,Arial,sans-serif;">DB-MT</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Label in
DBR file</td>
      </tr>
      <tr>
        <td style="font-family: monospace; font-weight: bold;"><big> bIC</big></td>
        <td style="font-family: monospace;"><big>[nICb]</big></td>
        <td>Bulk amounts of
independent components, moles<br>
        </td>
        <td style="vertical-align: top;">0<br>
        </td>
        <td style="text-align: center;"> +</td>
        <td style="text-align: center;">(+)</td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> -</td>
        <td style="font-family: monospace;"><big>bIC<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> rMB</big></td>
        <td style="font-family: monospace;"><big> [nICb]</big></td>
        <td> Mass balance residuals from GEMIPM, mol<br>
        </td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;">(+)</td>
        <td style="text-align: center;"> +</td>
        <td style="font-family: monospace;"><big>rMB<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace; font-weight: bold;"><big> uIC</big></td>
        <td style="font-family: monospace;"><big> [nICb]</big></td>
        <td> IC chemical potentials
(mol/mol)</td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> +</td>
        <td style="text-align: center;"> +<span
 style="font-family: monospace;"></span></td>
        <td style="font-family: monospace;"><big>uIC<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace; font-weight: bold;"><big> xDC</big></td>
        <td style="font-family: monospace;"><big> [nDCb]</big></td>
        <td> DC amounts at equilibrium, mol</td>
        <td style="vertical-align: top;">0<br>
        </td>
        <td style="text-align: center;"> {+}</td>
        <td style="text-align: center;"> {(+)}</td>
        <td style="text-align: center;"> (+)</td>
        <td style="text-align: center;"> +</td>
        <td style="font-family: monospace;"><big>xDC<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> gam</big></td>
        <td style="font-family: monospace;"><big> [nDCb]</big></td>
        <td>DC activity coefficients</td>
        <td style="vertical-align: top;">1<br>
        </td>
        <td style="text-align: center;">{+}</td>
        <td style="text-align: center;"> {+}</td>
        <td style="text-align: center;"> +</td>
        <td style="text-align: center;"> +</td>
        <td style="font-family: monospace;"><big>gam<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> dul</big></td>
        <td style="font-family: monospace;"><big> [nDCb]</big></td>
        <td>Upper kinetic restrictions on xDC<br>
        </td>
        <td style="vertical-align: top;">1e6<br>
        </td>
        <td style="text-align: center;"> +</td>
        <td style="text-align: center;">(+)</td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> -</td>
        <td style="font-family: monospace;"><big>dul<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> dll</big></td>
        <td style="font-family: monospace;"><big> [nDCb]</big></td>
        <td>Lower kinetic restrictions on xDC<br>
        </td>
        <td style="vertical-align: top;">0<br>
        </td>
        <td style="text-align: center;">]+</td>
        <td style="text-align: center;"> (+)</td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> -</td>
        <td style="font-family: monospace;"><big>dll<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> aPH</big></td>
        <td style="font-family: monospace;"><big> [nPHb]</big></td>
        <td> Specific surface areas of phases, m2/g</td>
        <td style="vertical-align: top;">0<br>
        </td>
        <td style="text-align: center;"> +</td>
        <td style="text-align: center;"> +</td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> -</td>
        <td style="font-family: monospace;"><big>aPH<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace; font-weight: bold;"><big> xPH</big></td>
        <td style="font-family: monospace;"><big> [nPHb]</big></td>
        <td> Total amounts of phases, mol<br>
        </td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> (+)</td>
        <td style="text-align: center;"> +</td>
        <td style="font-family: monospace;"><big>xPH<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> vPS</big></td>
        <td style="font-family: monospace;"><big> [nPSb]</big></td>
        <td>Volumes of phases-solutions, cm3<br>
        </td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;">(+)</td>
        <td style="text-align: center;"> +</td>
        <td style="font-family: monospace;"><big>vPS<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> mPS</big></td>
        <td style="font-family: monospace;"><big> [nPSb]</big></td>
        <td> Masses of phases-solutions, g<br>
        </td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> (+)</td>
        <td style="text-align: center;"> +</td>
        <td style="font-family: monospace;"><big>mPS<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace; font-weight: bold;"><big> bPS</big></td>
        <td style="font-family: monospace;"><big> [nPSb][nICb]</big></td>
        <td>Bulk compositions of phases-solutions, mol<br>
        </td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> (+)</td>
        <td style="text-align: center;"> +</td>
        <td style="font-family: monospace;"><big>bPS<br>
        </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> xPA</big></td>
        <td style="font-family: monospace;"><big> [nPSb]</big></td>
        <td>Amounts of solvent/sorbent in phases-solutions, mol<br>
        </td>
        <td style="vertical-align: top;"><br>
        </td>
        <td style="text-align: center;">-</td>
        <td style="text-align: center;"> -</td>
        <td style="text-align: center;"> (+)</td>
        <td style="text-align: center;"> +</td>
        <td style="font-family: monospace;"><big>xPA<br>
        </big></td>
      </tr>
    </tbody>
  </table>
  <p><span style="font-family: monospace;"></span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Symbols in
parenthesis (+) indicate data items that are automatically scaled when
loaded from DATABR instance into MULTI structure by multiplying by a
specific storage coefficient </span><big><span
 style="font-family: monospace;">S</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">, or scaled back by
dividing with </span><big><span style="font-family: monospace;">S</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> when extracted from
MULTI to DATABR instance (valid from GEMIPM2K v.2.3.0). Symbols in
braces {} indicate optional use for calculation of equilibrium in SIA
(smart initial approximation) mode of GEM IPM-2 algorithm. <br>
  </span></p>
  <p><br>
  <span style="font-family: Helvetica,Arial,sans-serif;">3. FMT node
properties, all scalar double values, can be used for storing mass
transport parameters for nodes mainly at TNodeArray implementation
level. This information is normally not exchanged in the single-call
FMT-GEM coupling at the TNode level.&nbsp; </span><br
 style="font-family: Helvetica,Arial,sans-serif;">
  </p>
  <table border="1" cellpadding="2" cellspacing="2" width="100%">
    <tbody>
      <tr>
        <td style="font-family: Helvetica,Arial,sans-serif;">ID</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Comment</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Default</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Label in
DBR file</td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> Tm</big></td>
        <td> Actual total simulation time, s</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> Tm</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> dt</big></td>
        <td> Actual time step, s</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> dt</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> Dif</big></td>
        <td> General diffusivity of disolved matter in the node</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> Dif</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> Vt</big></td>
        <td> Total volume of the node
(voxel), cm3</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> Vt</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> vp</big></td>
        <td> Advection velocity (in
pores) in this node, m/s<br>
        </td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> vp</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> eps</big></td>
        <td> Effective (actual) porosity normalized to 1</td>
        <td> 1</td>
        <td style="font-family: monospace;"><big> eps</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> Km</big></td>
        <td> Actual permeability, m2</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> Km </big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> Kf</big></td>
        <td> Actual DARCY`s constant,
m2/s</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> Kf</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> S</big></td>
        <td> Specific storage
coefficient , dimensionless</td>
        <td> 1</td>
        <td style="font-family: monospace;"><big> S</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> Tr</big></td>
        <td> Transmissivity in the node, m2/s</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> Tr</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> h</big></td>
        <td> Actual hydraulic head
(hydraulic potential), m</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> h</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> rho</big></td>
        <td> Actual carrier density for density-driven
flow, g/cm3</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> rho</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> al</big></td>
        <td> Specific longitudinal
dispersivity of porous media, m</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> al</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> at</big></td>
        <td> Specific transversal
dispersivity of porous media, m</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> at</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> av</big></td>
        <td> Specific vertical
dispersivity of porous media, m</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> av</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> hDl</big></td>
        <td>Hydraulic longitudinal dispersivity, m2/s<br>
        </td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> hDl</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> hDt</big></td>
        <td> Hydraulic transversal dispersivity, m2/s</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> hDt</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> hDv</big></td>
        <td> Hydraulic vertical dispersivity, m2/s</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> hDv</big></td>
      </tr>
      <tr>
        <td style="font-family: monospace;"><big> nto</big></td>
        <td> Tortuosity factor</td>
        <td> 1</td>
        <td style="font-family: monospace;"><big> nto</big></td>
      </tr>
    </tbody>
  </table>
  <p> </p>
  <p><span style="font-family: monospace;"><br>
  </span><span style="font-family: Helvetica,Arial,sans-serif;">The
scaling factor S may be used for scaling the input/output extensive
variables of GEM IPM for keeping the size of reactive sub-system in GEM
runs approximately the same, regardless of the node size. Especially
in&nbsp; finite-element methods, this can improve numerical accuracy of
GEM calculations (under construction, to be implemented since v.2.3.0).</span><span
 style="font-family: monospace;"> <br>
  <br style="font-family: monospace;">
  </span><span style="font-family: monospace;"></span> <span
 style="font-family: monospace;"></span><br>
  <span style="font-family: Helvetica,Arial,sans-serif;">4. GEM IPM-2
and FMT operation control flags and return codes (all scalar short
integer values)</span><br>
  </p>
  <table border="1" cellpadding="2" cellspacing="2" width="100%">
    <tbody>
      <tr>
        <td style="font-family: Helvetica,Arial,sans-serif;">ID</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Comment</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Default</td>
        <td style="font-family: Helvetica,Arial,sans-serif;"> Label in
DBR file</td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> NodeHandle</span></big></td>
        <td> Node identification handle</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> NodeHandle</big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> NodeTypeHY</span></big></td>
        <td> Node type (hydraulic) see typedef
NODETYPE</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> NodeTypeHY</big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> NodeTypeMT</span></big></td>
        <td> Node type (mass transport) see
typedef NODETYPE</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> NodeTypeMT</big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> NodeStatusFMT</span></big></td>
        <td> Node status code FMT see typedef NODECODEFMT</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> NodeStatusFMT</big></td>
      </tr>
      <tr>
        <td style="font-weight: bold;"><big><span
 style="font-family: monospace;"> NodeStatusCH</span></big></td>
        <td> Node status code CH see typedef NODECODECH</td>
        <td> 1</td>
        <td style="font-family: monospace;"><big> NodeStatusCH</big></td>
      </tr>
      <tr>
        <td><big><span style="font-family: monospace;"> IterDone</span></big></td>
        <td> Total number of iterations
performed in the last GEM IPM-2 run for this node</td>
        <td> 0</td>
        <td style="font-family: monospace;"><big> IterDone</big></td>
      </tr>
    </tbody>
  </table>
  <p><span style="font-family: monospace;"></span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The first
four flags are only important for the FMT part implemented at
TNodeArray level. For calling the GEM IPM-2 calculations, the</span><big><span
 style="font-family: monospace;"> NodeStatusCH</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">&nbsp; flag is
extremely important. This flag sets the GEM initial approximation mode
and is reset after GEM calculation to GEM IPM-2 return code. Hence, the
MT part must reset this flag every time when the GEM calculation must
be done, and check the return value after getting the control back from
GEMIPM2K. Most important situations (at simple TNode level of
coupling): <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">AIA
(simplex) initial approximation mode of GEM calculations (slow but more
accurate and reproducible results): Before calling GEM: set </span><big><span
 style="font-family: monospace;">NodeStatusCH</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> to 1 (</span><span
 style="font-family: monospace;">NEED_GEM_AIA</span><span
 style="font-family: Helvetica,Arial,sans-serif;">). After GEM
calculation: check that </span><big><span
 style="font-family: monospace;">NodeStatusCH</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> contains 2 (</span><span
 style="font-family: monospace;">OK_GEM_AIA</span><span
 style="font-family: Helvetica,Arial,sans-serif;">). If yes then copy
GEM results to MT data structures and proceed with the next node. If
no, but </span><big><span style="font-family: monospace;">NodeStatusCH</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> contains 3 (</span><span
 style="font-family: monospace;">BAD_GEM_AIA</span><span
 style="font-family: Helvetica,Arial,sans-serif;">) then decide on
further actions (e.g. check whether the current bulk composition in the
reactive sub-system is well balanced). If NodeStatusCH contains 4 (</span><span
 style="font-family: monospace;">ERR_GEM_AIA</span><span
 style="font-family: Helvetica,Arial,sans-serif;">) or 9 (</span><span
 style="font-family: monospace;">T_ERROR_GEM</span><span
 style="font-family: Helvetica,Arial,sans-serif;">), generate a
diagnostic message and break the coupled modeling calculations. Code 9
(terminal error) usually reflects the dynamic memory corruption in GEM
IPM-2 kernel. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">SIA (smart)
initial approximation mode of GEM calculations (fast but results may be
less accurate and, in general, not exactly reproducible): </span><span
 style="font-family: Helvetica,Arial,sans-serif;">Before calling GEM:
set </span><big><span style="font-family: monospace;">NodeStatusCH</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> to 5 (</span><span
 style="font-family: monospace;">NEED_GEM_SIA</span><span
 style="font-family: Helvetica,Arial,sans-serif;">). After GEM
calculation: check that </span><big><span
 style="font-family: monospace;">NodeStatusCH</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> contains 6 (</span><span
 style="font-family: monospace;">OK_GEM_SIA</span><span
 style="font-family: Helvetica,Arial,sans-serif;">) or 2 (</span><span
 style="font-family: monospace;">OK_GEM_AIA</span><span
 style="font-family: Helvetica,Arial,sans-serif;">).
If yes then copy GEM results to MT data structures and proceed with the
next node. Code 2 in this situation means that the GEM IPM algorithm
had found the node chemical speciation inappropriate as initial
approximation and has switched to the automatic (simplex) initial
approximation. Accordingly, error codes 3 or 4 mean the same as above
for the AIA start. Seldom, </span><big><span
 style="font-family: monospace;">NodeStatusCH</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> may contain 7 (</span><span
 style="font-family: monospace;">BAD_GEM_SIA</span><span
 style="font-family: Helvetica,Arial,sans-serif;">) or 8 (</span><big><span
 style="font-family: monospace;">ERR_GEM_SIA</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">); if so, the MT part
may try re-starting GEM calculation for this node in the AIA mode. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The </span><big><span
 style="font-family: monospace;">IterDone</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> field can be used
after a GEM calculation for diagnostic purposes (e.g. to keep track of
GEM IPM-2 performance). The TNode class also provides several function
calls that return the elapsed and pure GEM calculation time. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;"><br>
  </span></p>
  <h3><a name="TNODE"></a> 2.5. The TNode Class - a Minimum Data
Exchange Interface for Coupling with Existing Transport Codes</h3>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The TNode
C++ class (defined in </span><a href="../../node.h"><big><span
 style="font-family: monospace;">node.h</span></big></a><span
 style="font-family: Helvetica,Arial,sans-serif;"> file, implemented in
  </span><a href="../../node.cpp"><big><span
 style="font-family: monospace;">node.cpp</span></big></a><span
 style="font-family: Helvetica,Arial,sans-serif;"> and </span><a
 href="../../node_format.cpp"><big><span style="font-family: monospace;">node_format.cpp</span></big></a><span
 style="font-family: Helvetica,Arial,sans-serif;"> files) provides
methods (function calls) for easy coupling GEMIPM2K with already
existing transport codes that keep chemical information in own data
arrays. The </span><a href="../../main.cpp"><big><span
 style="font-family: monospace;">main.cpp</span></big></a><span
 style="font-family: Helvetica,Arial,sans-serif;"> file in </span><big><span
 style="font-family: monospace;">GEMIPM2K</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> directory offers an
example of batch calculation of chemical equilibria with input data
given in DCH, IPM and one or more DBR files; the results are written
into DBR files. The </span><big><span style="font-family: monospace;">main.cpp</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> file in </span><big><span
 style="font-family: monospace;">node_gem</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> directory&nbsp;
shows how the coupling with "transport part" having chemical data for
several nodes arranged in arrays can be organized. In <a
 href="#TEST_TNODE">this example</a>, no real mass transport is
performed; its effect is just simulated by a loop that changes stepwise
bulk compositions (</span><big><span style="font-family: monospace;">bIC
  </span></big><span style="font-family: Helvetica,Arial,sans-serif;">vectors)
in the nodes. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">During
initialization, the TNode class constructor dynamically allocates one
instance of TMULTI, one instance of DATACH, and one instance of DATABR
data structures. </span><span
 style="font-family: Helvetica,Arial,sans-serif;">The dynamic arrays in
DATACH and DATABR are allocated in </span><big><span
 style="font-family: monospace;">datach_from_text_file()</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> or </span><big><span
 style="font-family: monospace;">datach_from_file()</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> functions upon
reading the text or binary DCH file, respectively. The arrays in DATACH
are filled out with data upon further reading of DCH file. The dynamic
arrays of MULTI are allocated upon reading the IPM file, then all
relevant data are copied from DATACH to MULTI structure arrays. The
data in DATABR are read from DBR file in&nbsp; </span><big><span
 style="font-family: monospace;">databr_from_text_file()</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> or </span><big><span
 style="font-family: monospace;">databr_from_file()</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> functions. The
format of text IPM, DCH and DBR files is described in detail in a <a
 href="gemipm2k-inp.html">companion document</a>. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">As seen in
example main.cpp files from GEMIPM2K or node_gem directories, the whole
work on initializing and filling out the <br>
GEMIPM2K data structures on TNode level is done by three code lines:<br>
  </span></p>
  <p style="margin-left: 40px; font-family: monospace;"><big>TNode*
worknode&nbsp; = new TNode();<br>
if( worknode-&gt;GEM_init( input_system_file_list_name ) )<br>
&nbsp;&nbsp; return 1;&nbsp; // Error in reading GEMIPM2K input files<br>
  </big></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><big><small><span
 style="font-family: Helvetica,Arial,sans-serif;">Here, </span></small><span
 style="font-family: monospace;">input_system_file_list_name</span></big>
is a <big><span style="font-family: monospace;">char[]</span></big>
identifier containing a string with path name of a text file with a
list of DCH, IPM and DBR input file names. For instance, assuming that
GEMIPM2K text input files <big><span style="font-family: monospace;">Test1-dat.lst,&nbsp;
Test1-dch.dat, Test1-ipm.dat</span></big> and <big><span
 style="font-family: monospace;">Test1-dbr-0.dat</span></big> are
prepared in <big><span style="font-family: monospace;">./testdir/</span></big>
subdirectory, the&nbsp; <big><span style="font-family: monospace;">input_system_file_list_name</span>&nbsp;</big>
should contain <big><span style="font-family: monospace;">"testdir/Test1-dat.lst"</span></big>.
The file&nbsp; <big><span style="font-family: monospace;">Test1-dat.lst</span><small><span
 style="font-family: Helvetica,Arial,sans-serif;"> should contain the
following text: <br>
  </span></small></big></p>
  <p style="font-family: Helvetica,Arial,sans-serif; margin-left: 40px;"><big><small><span
 style="font-family: Helvetica,Arial,sans-serif;"></span></small></big><big><span
 style="font-family: monospace;">-t "Test1-dch.dat" "Test1-ipm.dat" "</span></big><big><span
 style="font-family: monospace;">Test1-dbr-0.dat"</span></big><br>
  </p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The </span><big><span
 style="font-family: monospace;">-t</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> key tells the
program to read text input files (</span><big><span
 style="font-family: monospace;">-b</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> would be binary
files), then the name of DCH file, then IPM file, and at least one DBR
file (always in this order). These files must be present in the same
directory where the </span><big><span style="font-family: monospace;">*dat.lst</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> file is located.
Multiple DBR files will be read only by calling GEMIPM2K on <a
 href="#TNODEARRAY">TNodeArray level (see next section)</a>; on TNode
level, only the first DBR file is read and others will be ignored. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">However,
the TNode class provides a function that can read other DBR files
one-by-one at any time. The simplest call is like this: <br>
  </span></p>
  <p style="margin-left: 40px;"><big><span
 style="font-family: monospace;">if( worknode-&gt;GEM_read_dbr(
NextRecipeFileName ) ) <br>
&nbsp;&nbsp; return 2; </span></big><big>// <span
 style="font-family: monospace;">Error in reading DBR input file</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The </span><big><span
 style="font-family: monospace;">NextRecipeFileName</span></big><big><span
 style="font-family: monospace;"></span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">
is a</span> <big><span style="font-family: monospace;">char[]</span></big>
  <span style="font-family: Helvetica,Arial,sans-serif;">identifier
containing a string with path name of a text DBR file (in our example,
it may be &nbsp;</span> <big><span style="font-family: monospace;">"testdir/Test1-dbr-1.dat"</span></big>
)<span style="font-family: Helvetica,Arial,sans-serif;"> Since there is
only one DATABR structure linked to the TNode class instance, this call
destroys any previous bulk composition and speciation kept in the TNode
instance&nbsp; </span><big><span style="font-family: monospace;">node</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">After the
DBR file information has been read, the chemical equilibrium can be
calculated. This is normally done with the following C++ lines:<br>
  </span></p>
  <p style="margin-left: 40px;"><span style="font-family: monospace;"><big>int
StatusGEM;</big><br>
// Get direct access to work node DATABR structure which exchanges data
between GEMIPM and FMT parts<br>
  <big>DATABR* wdbr = worknode-&gt;pCNode();</big></span></p>
  <p style="margin-left: 40px;"><span style="font-family: monospace;"><big>wdbr-&gt;NodeStatusCH
= NEED_GEM_AIA; </big>// Ask GEM to run with automatic initial
approximation<br>
  <big>StatusGEM = worknode-&gt;GEM_run( false );</big><br>
  </span></p>
  <p style="margin-left: 40px;"><span style="font-family: monospace;"><big>if(
StatusGEM != OK_GEM_AIA )</big>&nbsp; // Check the GEM return code <br>
  <big>{</big>&nbsp; <br>
&nbsp;&nbsp; <big>cout &lt;&lt; endl &lt;&lt; "Error in GEM
calculation for DBR file " <small>&lt;&lt; </small></big></span><big
 style="font-family: monospace;">NextRecipeFileName <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;&lt; " return code " &lt;&lt;
StatusGEM;<small> </small><br>
&nbsp; return 3; <br>
  </big><span style="font-family: monospace;"><big>}</big>&nbsp; </span><span
 style="font-family: Helvetica,Arial,sans-serif;"><br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">After
successfull GEM calculation, the resulting speciation, activity
coefficients etc. are&nbsp; returned in the same work DATABR structure
where the input bulk composition, temperature and pressure were
provided (by reading the last DBR file). The easiest way to look at the
results is to write them back into the same DBR file: <br>
  </span></p>
  <p style="margin-left: 40px;"><big><span
 style="font-family: monospace;">worknode-&gt;GEM_write_dbr(
NextRecipeFileName, false, false );</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"><br>
  </span></p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The file contents
can be viewed with any text viewer or editor. You can also produce a
copy of the DBR file with current GEM input and results by using the
same call but with different file name: <br>
  </p>
  <p style="font-family: monospace; margin-left: 40px;"><big>char
NextResultFileName[60] = "testdir/Test1-dbr-1.out";<br>
worknode-&gt;GEM_write_dbr( NextResultFileName, false, true );<br>
  </big></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The second
parameter in </span><big><span style="font-family: monospace;">GEM_write_dbr()</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> call tells the
program to produce binary (</span><big><span
 style="font-family: monospace;">true</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">) or text (</span><big><span
 style="font-family: monospace;">false</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">) file. The third
parameter is used only in writing text DBR files: if set to&nbsp; </span><big><span
 style="font-family: monospace;">true</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> then each data item
is printed with comment lines for better readability, otherwise without
comments. </span><br>
  <span style="font-family: Helvetica,Arial,sans-serif;"></span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Detailed
contents of the MULTI data structure after GEM calculation can be found
in a text file produced with a call </span><br>
  </p>
  <p style="font-family: monospace; margin-left: 40px;"><big>char
NextPrintoutFileName[60] = "testdir/Test1-dbr-1.IPMprint.out";<br>
worknode-&gt;GEM_print_ipm( NextPrintoutFileName );<br>
  </big></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">This
formatted file cannot be read back by </span><big><span
 style="font-family: monospace;">GEM_init()</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> or </span><big><span
 style="font-family: monospace;">GEM_read_dbr()</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> methods, but it is
useful for detailed examination or comparisons of GEM inputs and
results, especially when GEM returns a bad status code. In the latter
case, a more exact error message can be found in the </span><big><span
 style="font-family: monospace;">ipmlog.txt</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> file located in the
executable file directory.<br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Any DBR
file can be modified in text editor (see the <a
 href="gemipm2k-inp.html">companion manual</a> for details) and then
used for the next calculation, as described above. Many variants of the
system, e.g. with different bulk compositions, can be prepared as DBR
files and processed in batch mode putting the code sequence above in a
loop. This is demonstrated in the </span><a href="../../main.cpp"><big><span
 style="font-family: monospace;">main.cpp</span></big></a><span
 style="font-family: Helvetica,Arial,sans-serif;"> file in </span><big><span
 style="font-family: monospace;">GEMIPM2</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> directory.<br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">However, on
the TNode level, the work DATABR structure can be read or modified
directly in the program memory, which is of course the most interesting
case for coupling GEM with an existing mass transport or reaction-path
modeling code. There are several ways to access data in DATACH and
DATABR or modify data in DATABR - from multi-parameter function calls
to direct memory access via dedicated methods or macroses. Some of
these are used in the </span><a href="../../../node-gem/main.cpp"><big><span
 style="font-family: monospace;">main.cpp</span></big></a><span
 style="font-family: Helvetica,Arial,sans-serif;"> example in </span><big><span
 style="font-family: monospace;">node_gem</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> directory.<br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;"><a
 name="NODE_GEM_INIT"></a>Direct access to members of DATACH and DATABR
instances is possible via the pointers obtained as shown in the C++
code
fragment below. </span><br>
  <span style="font-family: Helvetica,Arial,sans-serif;"></span></p>
  <p style="font-family: monospace; margin-left: 40px;"><big>#include
"node.h"<br>
  </big></p>
  <p style="font-family: monospace; margin-left: 40px;"><big>char[60]
input_system_file_list_name = "testdir/Test2-dat.lst";<br>
TNode* node&nbsp; = new TNode();<br>
if( node-&gt;GEM_init( ipm_input_file_list_name ) )<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 1;&nbsp;&nbsp; <br>
  </big></p>
  <p style="margin-left: 40px;"><big><span
 style="font-family: monospace;">DATACH* dCH = node-&gt;pCSD();</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">DATABR* dBR = node-&gt;pCNode();</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"><br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Through the
  </span><big><span style="font-family: monospace;">dCH</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> pointer, the
chemical system definition can be accessed. For instance,&nbsp; the
numbers of components and phases in DATACH and MULTI structures:<br>
  </span></p>
  <p style="font-family: monospace; margin-left: 40px;"><big>int nICs,
nDCs, nPHs, nPSs;<br>
  </big></p>
  <p style="margin-left: 40px;"><big><span
 style="font-family: monospace;">nICs =
dCH-&gt;nIC;&nbsp;&nbsp;&nbsp;&nbsp; // Number of independent components</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">nDCs =
dCH-&gt;nDC;&nbsp;&nbsp;&nbsp;&nbsp; // Number of dependent components
(chemical species)</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">nPHs =
dCH-&gt;nPH;&nbsp;&nbsp;&nbsp;&nbsp; // Number of phases </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">nPSs =
dCH-&gt;nPS;&nbsp;&nbsp;&nbsp;&nbsp; // Number of phases-solutions</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"><br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The names
of 2nd independent component, 3rd chemical species and 1st phase can be
easily retrieved as strings: &nbsp;</span></p>
  <p style="font-family: monospace; margin-left: 40px;"><big>char
ElementName[MaxICN+1];<br>
char ComponentName[MaxDCN+1];<br>
char PhaseName[MaxPHN+1];<br>
  </big></p>
  <p style="font-family: monospace; margin-left: 40px;"><big>strncpy(
ElementName, dCH-&gt;ICNL[2], MaxICN ); <br>
strncpy( ComponentName, dCH-&gt;DCNL[3], MaxDCN );<br>
strncpy( PhaseName, dCH-&gt;ICNL[1], MaxPHN ); <br>
  </big></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The molar
masses of ICs and DCs can also be retrieved directly as<br>
  </span></p>
  <p style="font-family: monospace; margin-left: 40px;"><big>double
AtMass2 = dCH-&gt;ICmm[2];<br>
double MolMass3 = dCH-&gt;DCmm[3]; <br>
  </big></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The number
of components included in the 1st phase can be found as <br>
  </span></p>
  <p style="margin-left: 40px;"><big><span
 style="font-family: monospace;">int NumCompPhase1 = dCH-&gt;nDCinPH[1];</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">and so on.
The
dimensions of data vectors in DATABR structure (and DBR file) can also
be easily retrieved:<br>
  </span></p>
  <p style="font-family: monospace; margin-left: 40px;"><big>int nICb,
nDCb, nPHb, nPSb;<br>
  </big></p>
  <p style="margin-left: 40px;"><big><span
 style="font-family: monospace;">nICb =
dCH-&gt;nICb;&nbsp;&nbsp;&nbsp;&nbsp; // Number of independent
components accessible through DATABR </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">nDCb =
dCH-&gt;nDCb;&nbsp;&nbsp;&nbsp;&nbsp; // Number of dependent components
  </span></big><big><span style="font-family: monospace;">accessible
through DATABR</span></big><big><span style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">nPHb =
dCH-&gt;nPHb;&nbsp;&nbsp;&nbsp;&nbsp; // Number of phases </span></big><big><span
 style="font-family: monospace;">exchanged accesible DATABR</span></big><big><span
 style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">nPSb =
dCH-&gt;nPSb;&nbsp;&nbsp;&nbsp;&nbsp; // Number of phases-solutions </span></big><big><span
 style="font-family: monospace;">accessible through DATABR</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">This allows
us to copy or write a whole data vector from/to the data&nbsp; bridge
structure. For example, the bulk composition of the system can be
retrieved and even modified: <br>
  </span></p>
  <div style="margin-left: 40px;"><big><span
 style="font-family: monospace;">double bc[]; </span></big><br
 style="font-family: monospace;">
  <big><span style="font-family: monospace;">bc = new double[nICb]; </span></big><br
 style="font-family: monospace;">
  <big><span style="font-family: monospace;">for(int i=0; i&lt;nICb;
i++)</span></big><br style="font-family: monospace;">
  <big><span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; bc[i] =
dBR-&gt;bIC[i]; <br>
.........................<br>
bc[2] +=
0.01;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// in moles<br>
  </span></big><big><span style="font-family: monospace;">dBR-&gt;bIC[2]
= bc[2];</span></big><br style="font-family: monospace;">
  </div>
  <p><span style="font-family: Helvetica,Arial,sans-serif;"> </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Useful
direct-access methods are defined in the public section of TNode class
definition in the </span><a href="../../node.h"><big><span
 style="font-family: monospace;">node.h</span></big></a><span
 style="font-family: Helvetica,Arial,sans-serif;"> file (can be
extended in future versions of GEMIPM2K). <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">It is
important to keep in mind that in the TNode class, two systems for
indexation of components and phases are used: one for DATACH/MULTI data
lists and data arrays, and another for the DATABR data arrays. These
two indexation systems are connected via the <a href="#INDEX_MAPPING">index
mapping lists</a> in the DATACH structure. Both indexation systems are
identical only in the trivial one-to-one mapping case when </span><big><span
 style="font-family: monospace;">nICb == nICs, nDCb == nDCs, nPHb ==
nPHs</span></big><span style="font-family: Helvetica,Arial,sans-serif;">,
i.e. data for all components and phases are exchanged through DATABR
structure or DBR file. In a general case, some components and phases
are not exchanged or transported between nodes, so </span><big><span
 style="font-family: monospace;">nICb &lt;= nICs, nDCb &lt;= nDCs, nPHb
&lt;= nPHs</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">. </span><span
 style="font-family: Helvetica,Arial,sans-serif;"></span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The TNode
class contains methods that search for both kinds of indexes for a
given component or phase name and convert an index of one kind into
another. For instance, the indexes for Ca+2 ion (assuming that it is
present in the DATACH structure list) can be found using the lines
below:<br>
  </span></p>
  <p style="font-family: monospace; margin-left: 40px;"><big>int
xcCa_ion = node-&gt;DC_name_to_xCH("Ca+2");<br>
int xbCa_ion = node-&gt;DC_name_to_xDB("Ca+2");<br>
if( xbCa_ion &lt; 0 )<br>
&nbsp;&nbsp;&nbsp; cout &lt;&lt; "Error - data for the Ca+2 ion are not
exchanged through DATABR!"; <br>
  </big></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The known
DATABR index of the Ca+2 component can be directly converted into
DATACH index, and vice versa: <br>
  </span></p>
  <div style="margin-left: 40px;"><big><span
 style="font-family: monospace;">xcCa_ion = DC_xDB_to_xCH( xbCa_ion );</span></big><br
 style="font-family: monospace;">
  <big><span style="font-family: monospace;">....................................</span></big><br
 style="font-family: monospace;">
  <big><span style="font-family: monospace;">xbCa_ion = DC_xCH_to_xDB(
xcCa_ion );</span></big><br>
  </div>
  <p><span style="font-family: Helvetica,Arial,sans-serif;"></span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Similar
methods are also provided for independent components and phases. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Normally,
the mass transport part of the coupled code should see only the data
accessible via the DATABR interface. For example, the amount of Ca+2 in
the node is simply accessible as&nbsp; </span><big><span
 style="font-family: monospace;">dbr-&gt;xDC[xbCa_ion]</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">&nbsp; through DATABR
index of Ca+2. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">However,
there are some useful numbers (such as molar masses or thermodynamic
properties of chemical species) that are not directly accessible using
the DATABR indexation. For such data, macroses are provided. For the
above example, the molar mass of Ca+2 with DATABR index&nbsp; </span><big><span
 style="font-family: monospace;">xbCa_ion </span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">can be obtained as <br>
  </span></p>
  <p style="margin-left: 40px;"><big><span
 style="font-family: monospace;">double mmCa_ion = nodeCH_DCmm(
xbCa_ion
); </span></big><span style="font-family: Helvetica,Arial,sans-serif;"><br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Assuming
that independent component Ca is exchanged in DATABR, the stoichiometry
coefficient of Ca in Ca+2 species can be obtained as <br>
  </span></p>
</blockquote>
<p style="margin-left: 80px;"><big><span style="font-family: monospace;">int
xbCa_IC = node-&gt;IC_name_to_xDB( "Ca" );</span><br
 style="font-family: monospace;">
<span style="font-family: monospace;">float scCa = nodeCH_A( xbCa_ion,
xbCa_IC );</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"><br>
</span></p>
<blockquote>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The direct
access methods outlined above are especially useful when the transport
algorithm is implemented using TNodeArray class because the transport
part then may not maintain its own data structures for keeping chemical
properties in all nodes. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">For
coupling with existing transport codes that keep arrays with chemical
speciation for all nodes, the integrated GEMIPM calls are more useful.
Typical sequence of such calls is shown in the </span><a
 href="../../../node-gem/main.cpp"><big><span
 style="font-family: monospace;">main.cpp</span></big></a><span
 style="font-family: Helvetica,Arial,sans-serif;"> file of the </span><big><span
 style="font-family: monospace;">/node_gem</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">
example directory.&nbsp; Here we assume that the memory in the mass
transport part is allocated in separate vectors or arrays for each
property: <br>
  </span></p>
  <div style="margin-left: 40px;"><span style="font-family: monospace;">&nbsp;&nbsp;
const int nNodes =&nbsp; 100;&nbsp;&nbsp; // set here how many nodes
you need&nbsp; <br>
&nbsp;&nbsp; ..........................<br>
  <br>
&nbsp;&nbsp; short m_NodeHandle[nNodes], m_NodeStatusCH[nNodes],
m_IterDone[nNodes];</span><span style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; double
m_T[nNodes], m_P[nNodes], m_Vs[nNodes], m_Ms[nNodes],</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
m_Gs[nNodes], m_Hs[nNodes], m_IC[nNodes], m_pH[nNodes],</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_pe[nNodes], m_Eh[nNodes];</span><br
 style="font-family: monospace;">
  <br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; double m_xDC[],
m_gam[], m_xPH[], m_aPH[], m_vPS[], m_mPS[],m_bPS[],</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
m_xPA[], m_dul[], m_dll[], m_bIC[], m_rMB[], m_uIC[];</span><br
 style="font-family: monospace;">
  <br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_bIC = new
double[ nNodes*nICb ];</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_rMB = new
double[ nNodes*nICb ];</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_uIC = new
double[ nNodes*nICb ];</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_xDC = new
double[ nNodes*nDCb ];</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_gam = new
double[ nNodes*nDCb ];</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_dul = new
double[ nNodes*nDCb ];</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_dll = new
double[ nNodes*nDCb ];</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_aPH = new
double[ nNodes*nPHb ];</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_xPH = new
double[ nNodes*nPHb ];</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_vPS = new
double[ nNodes*nPSb ];</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_mPS = new
double[ nNodes*nPSb ];</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_xPA = new
double[ nNodes*nPSb ];</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; m_bPS = new
double[ nNodes*nICb*nPSb ];</span><span
 style="font-family: Helvetica,Arial,sans-serif;"></span><br>
  <span style="font-family: Helvetica,Arial,sans-serif;"></span></div>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Initially,
the chemical information should be loaded in these arrays from
input files of the mass-transport part, but this would require a lot of
extra work to produce such MT input files consistent with GEM chemical
system definition. Keeping in mind that the whole set of <a
 href="#GEMS_GENERATE_INPUT_FILES">GEMIPM2K input files can easily be
generated from GEMS-PSI</a> modelling project, it is much easier to use
a </span><a href="#NODE_GEM_INIT"><big><span
 style="font-family: monospace;">node-&gt;GEM_init()</span></big></a><span
 style="font-family: Helvetica,Arial,sans-serif;"><a
 href="#NODE_GEM_INIT"> call</a> to read at least one DBR file,
retrieve numbers of components and phases whose data are exchanged via
the DATABR structure, allocate the arrays (see above), and fill them
out by
organizing a loop like the one shown below:<br>
  </span></p>
  <p><span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
dBR-&gt;NodeStatusCH = NEED_GEM_AIA; <br>
&nbsp;&nbsp;&nbsp;&nbsp; int NodeStatusCH = node-&gt;GEM_run( false );<br>
  <br>
&nbsp;&nbsp;&nbsp;&nbsp; if( NodeStatusCH != OK_GEM_AIA )<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 5; // GEM IPM did not
converge properly on these input data<br>
  <br>
  </span><span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
for( int in=0; in&lt;nNodes; in++ )</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp; &nbsp;&nbsp; {</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// Extracting GEM IPM input chemical data into MT part</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
node-&gt;GEM_restore_MT( m_NodeHandle[in], m_NodeStatusCH[in],</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
m_T[in], m_P[in], m_Vs[in], m_Ms[in],</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
m_bIC+in*nICb, m_dul+in*nDCb, m_dll+in*nDCb, m_aPH+in*nPHb );</span><br
 style="font-family: monospace;">
  <br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// Extracting GEM IPM output chemical data into MT part</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
node-&gt;GEM_to_MT( m_NodeHandle[in], m_NodeStatusCH[in],
m_IterDone[in],</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
m_Vs[in], m_Ms[in], m_Gs[in], m_Hs[in], m_IC[in], m_pH[in], m_pe[in],</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
m_Eh[in], m_rMB+in*nICb, m_uIC+in*nICb, m_xDC+in*nDCb, m_gam+in*nDCb,</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
m_xPH+in*nPHb, m_vPS+in*nPSb, m_mPS+in*nPSb,</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
m_bPS+in*nICb*nPSb, m_xPA+in*nPSb );</span><span
 style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; &nbsp; }</span><span
 style="font-family: Helvetica,Arial,sans-serif;"><br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">This code
fragment would assign the same chemical composition and speciation to
reactive part in all nodes.&nbsp; However, some nodes usually must be
assigned different composition. For instance, the very first node (with
index 0) may be set up as a boundary condition of the infinite source
type.&nbsp; The corresponding chemical composition and speciation can
be prepared as a separate system variant in GEMS and saved in another
DBR file (compatible with already used DCH and IPM files). One or more
such DBR files can be read separately and their chemical data assigned
to certain nodes as shown below:</span></p>
  <p style="font-family: monospace; margin-left: 40px;">char[60]
dbr_input_file_name = "testdir/Test2-boundary-0-dbr.dat";<span
 style="font-family: monospace;">&nbsp; <br>
  </span></p>
  <p style="font-family: monospace; margin-left: 40px;"><span
 style="font-family: monospace;">if( node-&gt;GEM_read_dbr(
dbr_input_file_name ) ) </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; return 2; // Error
in reading DBR input file</span><br style="font-family: monospace;">
  <span style="font-family: monospace;"><br>
dBR-&gt;NodeStatusCH = NEED_GEM_AIA; <br>
int NodeStatusCH = node-&gt;GEM_run( false );<br>
if( NodeStatusCH != OK_GEM_AIA )<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 5; // GEM IPM did not
converge properly on these input data<br>
  </span><span style="font-family: monospace;"><br>
int xBCnodes[3] = { 0, 33, 66 };</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">for( int in, i=0; i&lt;3; i++ )
// Initialising boundary condition node(s)</span><br>
{<br>
&nbsp;&nbsp; in = xBCnodes[i];<br>
&nbsp;&nbsp; node-&gt;GEM_restore_MT( m_NodeHandle[in],
m_NodeStatusCH[in], m_T[in],<br>
&nbsp; &nbsp;&nbsp; m_P[in], m_Vs[in], m_Ms[in], m_bIC+in*nIC,
m_dul+in*nDC, m_dll+in*nDC, m_aPH+in*nPH );<br>
&nbsp;&nbsp; node-&gt;GEM_to_MT( m_NodeHandle[in], m_NodeStatusCH[in],
m_IterDone[in],<br>
&nbsp;&nbsp;&nbsp; m_Vs[in], m_Ms[in], m_Gs[in], m_Hs[in], m_IC[in],
m_pH[in], m_pe[in],<br>
&nbsp;&nbsp;&nbsp; m_Eh[in], m_rMB+in*nIC, m_uIC+in*nIC, m_xDC+in*nDC,
m_gam+in*nDC,<br>
&nbsp;&nbsp;&nbsp; m_xPH+in*nPH, m_vPS+in*nPS, m_mPS+in*nPS,
m_bPS+in*nIC*nPS, m_xPA+in*nPS ); <br>
}<br>
  </p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The GEM run
in the above code snippet can be skipped, though we recommend having it
there for checking whether the input files are consistent and the
equilibrium can be calculated flawlessly. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Now, after
the initial chemical speciation and composition has been distributed
over all nodes, the main loop of mass transport modelling begins.
Whatever the method used for solving transport and mass conservation
equations, this will re-distribute some components of mobile phases
(usually aqueous species)&nbsp; between nodes and accordingly will
change their bulk compositions at the next time point. All this will be
done on elements of the </span><big><span
 style="font-family: monospace;">m_xDC</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> array if aqueous
ions and complexes are transported, or on the elements of </span><big><span
 style="font-family: monospace;">m_bPS</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> if only the bulk
aqueous and/or fluid phase(s) is transported (e.g. by pure advection).
From this changed speciation </span><big><span
 style="font-family: monospace;">xDC</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> or aqueous/fluid
composition </span><big><span style="font-family: monospace;">m_bPS</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">, the changes to the
system bulk composition vector </span><big><span
 style="font-family: monospace;">m_bIC</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> are computed (with
possibly changes in temperatures </span><big><span
 style="font-family: monospace;">m_T</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> and pressures </span><big><span
 style="font-family: monospace;">m_P</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">, in some nodes, as
well as kinetic constraints </span><big><span
 style="font-family: monospace;">m_dul, m_dll</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> for some
components). <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Next, the
equilibria in every node must be re-calculated in order to correct for
phase assemblage and speciation that may eventually change because of
changed bulk chemical composition, temperature, pressure, or kinetic
constraints e.g. for mineral dissolution or precipitation. The
re-equilibration may change phase volumes or aqueous speciation, which
in turn may change transport between some nodes at the next time step.
So, this "operator-splitting" reactive transport modelling is performed
by alternating transport and chemistry loops over nodes, embedded in
the time integration loop. The code fragment below shows how the
chemistry loop may look like when GEMIPM2K </span><span
 style="font-family: Helvetica,Arial,sans-serif;"> TNode interface </span><span
 style="font-family: Helvetica,Arial,sans-serif;">functions are used. <br>
  </span></p>
  <p><span style="font-family: monospace;">double time = 0., dt=1,
CalcTime=0., MeanTotIt=0.;<br>
&nbsp; &nbsp; <br>
for( int it=0; it&lt;nTimes; it++ )&nbsp; // iterations over time</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">{</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; </span><span
 style="font-family: monospace;">//&nbsp; The call below&nbsp; stands
for the mass transport loop over all nodes</span><br>
  <span style="font-family: monospace;">&nbsp;&nbsp; dt =
MassTransportStep( nNodes, time, dt, m_T, m_P, m_Vs, m_Ms, </span><span
 style="font-family: monospace;">m_Hs, m_IC, m_pH,</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_Eh, m_xDC, m_xPH, m_aPH, m_vPS, m_mPS,
m_bPS,</span><span style="font-family: monospace;"> m_xPA, m_dul,
m_dll, m_bIC )</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; // Not all node
chemical data arrays may be changed in the mass transport step!</span> <br>
  </p>
  <p><span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp; for( int in=0;
in&lt;nNodes; in++ ) </span><span style="font-family: monospace;">//
Chemical equilibration loop over nodes</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; {&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int </span><span
 style="font-family: monospace;">nTotIt = 0;</span><span
 style="font-family: monospace;"> <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool UseNodeSpeciation = false; </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
m_NodeHandle[in] = in;</span><br style="font-family: monospace;">
&nbsp;<span style="font-family: monospace;"></span><span
 style="font-family: monospace;"> &nbsp; &nbsp;&nbsp;
m_NodeStatusCH[in] = NEED_GEM_AIA;&nbsp;&nbsp;&nbsp; // GEM Automatic
(simplex) initial approximation</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
m_NodeStatusCH[in] = NEED_GEM_SIA;&nbsp;&nbsp; // GEM Smart initial
approximation</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
UseNodeSpeciation =
true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// set true for GEM SIA if aqueous species are transported,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// set false if only aqueous bulk composition is moved <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
//&nbsp;&nbsp; or for GEM AIA if coupled with any transport algorithm<br
 style="font-family: monospace;">
  </span><span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
// Setting input data for GEM IPM</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
node-&gt;GEM_from_MT( m_NodeHandle[in], m_NodeStatusCH[in],</span><span
 style="font-family: monospace;"> m_T[in], m_P[in], <br>
&nbsp;&nbsp;&nbsp;&nbsp; m_Vs[in], m_Ms[in],</span><span
 style="font-family: monospace;"> m_bIC+in*nIC, m_dul+in*nDC,
m_dll+in*nDC, m_aPH+in*nPH, </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; m_xDC+in*nDC, m_gam+in*nDC ); <br>
  </span><span style="font-family: monospace;"></span><span
 style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; //
Calling GEM IPM2 calculation</span><span style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
m_NodeStatusCH[in] = node-&gt;GEM_run( UseNodeSpeciation );</span><span
 style="font-family: monospace;"></span><span
 style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; if( !(
m_NodeStatusCH[in] == OK_GEM_AIA || m_NodeStatusCH[in] == OK_GEM_SIA ) )</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cout &lt;&lt; endl &lt;&lt; "GEM
calculation error " &lt;&lt; </span><span
 style="font-family: monospace;">m_NodeStatusCH[in] &lt;&lt; " in node "<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;&lt; in &lt;&lt;&nbsp; " at time
" &lt;&lt; time+dt;&nbsp; </span><br>
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 5;</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; }<br>
&nbsp;&nbsp;&nbsp;&nbsp; CalcTime += node-&gt;GEM_CalcTime();&nbsp; //
Monitoring GEM calculation time</span><span
 style="font-family: monospace;"></span><span
 style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; nTotIt
+= m_IterDone[in];</span><br style="font-family: monospace;">
  <br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; //
Extracting GEM IPM output data to FMT part</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
node-&gt;GEM_to_MT( m_NodeHandle[in], m_NodeStatusCH[in],
m_IterDone[in],</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp; m_Vs[in], m_Ms[in], m_Gs[in], m_Hs[in], m_IC[in],
m_pH[in], m_pe[in],</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp; m_Eh[in],m_rMB+in*nIC, m_uIC+in*nIC, m_xDC+in*nDC, m_gam+in*nDC,</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp; m_xPH+in*nPH, m_vPS+in*nPS, m_mPS+in*nPS,</span><span
 style="font-family: monospace;"> m_bPS+in*nIC*nPS, m_xPA+in*nPS&nbsp;
);</span><br style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp; }</span><span
 style="font-family: monospace;"> <br>
&nbsp; MeanTotIt += (double)nTotIt / (double)nNodes; <br
 style="font-family: monospace;">
  </span><span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp; time += dt;&nbsp; // time
increment</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">}&nbsp; // End of time
integration loop<br>
  </span></p>
  <p><span style="font-family: monospace;">MeanTotIt /= nTimes; <br>
  </span><span style="font-family: monospace;">cout &lt;&lt; endl
&lt;&lt; "Total model time " &lt;&lt; time &lt;&lt; "&nbsp; Total GEM
runtime " &lt;&lt; CalcTime <br>
&nbsp;&nbsp;&nbsp; &lt;&lt; "&nbsp; Mean number of GEM iterations per
call " &lt;&lt; MeanTotIt; &nbsp; </span><span
 style="font-family: Helvetica,Arial,sans-serif;"><br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">In the
above code fragment, two kinds of monitoring GEM performance are
exemplified. The total GEM calculation time (in seconds) is collected
in </span><big><span style="font-family: monospace;">CalcTime</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> variable, and&nbsp;
the average number of iterations per GEM call is available at the
end&nbsp; from </span><big><span style="font-family: monospace;">MeanTotIt</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> varilable. Both
performance indicators strongly depends on setup and composition of the
chemical system, as well as on the computer processor and architecture,
as shown in the GEM performance report [<a href="#Ref_Dmytrieva-2008">Dmytrieva
et al., 2008</a>]. However, there is one explicit performance control -
namely, the choice of the mode of <a href="#INITIAL_APPROXIMATION">GEM
initial approximation</a>. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">In the code
fragment, the GEM calculation for each node is requested to start with
the AIA (automatic initial approximation)&nbsp; </span><span
 style="font-family: monospace;">NEED_GEM_AIA </span><span
 style="font-family: Helvetica,Arial,sans-serif;">mode.&nbsp; In this
mode, GEM calculations are 100% reproducible but rather slow (20 to 200
GEM iterations depending on the chemical system definition and
composition). The alternative SIA mode </span><span
 style="font-family: Helvetica,Arial,sans-serif;">(smart initial
approximation)</span><span
 style="font-family: Helvetica,Arial,sans-serif;">&nbsp; </span><span
 style="font-family: monospace;">NEED_GEM_SIA</span><span
 style="font-family: Helvetica,Arial,sans-serif;">&nbsp; uses the
currently available contents of the speciation (</span><big><span
 style="font-family: monospace;">xDC</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">) and activity
coefficients (</span><big><span style="font-family: monospace;">gam</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">) vectors (modified
through the DATABR interface) as the initial approximation. If the </span><big><span
 style="font-family: monospace;">xDC</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">
vector for the current node, modified after the mass transport time
step, does not violate the mass balance relative to the current bulk
composition vector </span><big><span style="font-family: monospace;">bIC</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">, and neither the
phase assemblage nor the redox
state are going to change, then GEM is expected to do 0 to 10
iterations, i.e. 10-20 times less than in the AIA mode. This
acceleration can be relevant for large
2-D or 3-D coupled RMT models. However, the SIA mode result is by
definition not exactly reproducible. Even repeated SIA mode
calculations for the same system always yield slightly different
amounts of dependent components because the previously computed
speciation taken as initial approximation is always slightly different.
However, it is unlikely that this may lead to diverging coupled
modelling results because any GEM-calculated speciation must converge
to the Gibbs energy minimum. nevertheless, the behavior of SIA mode GEM
calculation
relative to AIA in coupled models still needs more testing and
verification.<br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The SIA
GEM calculation mode may be preferable over the AIA mode when the
transport program part moves aqueous species. In this case, any changed
chemical speciation in the node is guaranteed to remain mass-balanced
because the corrections to the bulk composition vector </span><big><span
 style="font-family: monospace;">bIC</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> are
calculated from the corrections to </span><big><span
 style="font-family: monospace;">xDC</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">
vector. The latter then is a good initial approximation at least in the
sense of mass balance, so the <a href="#EFD_PROCEDURE">GEM EFD()
procedure</a> is not expected to do any extra iterations. In the most
meaningful RMT problems, the phase association changes or redox
transitions occur
along some distinct reaction fronts or barriers that are represented by
only a small fraction of the nodes. In such a node, it may happen that
the
current speciation turns to be a bad GEM initial approximation. The GEM
IPM kernel has several built-in criteria to check if this happens
indeed; if so, then the program "smartly" switches to simplex (AIA)
initial approximation and obtains correct new phase assemblage and
speciation just at cost of performing more iterations. However,&nbsp;
for the vast majority of nodes that lie not in the vicinity of rock
heterogeneities or reaction fronts, slight changes of speciation and
composition upon the transport time iteration would not result in any
phase or redox shifts. In this case, the SIA approximation appears safe
enough and GEM is expected to converge in 1,2 or 3 iterations. For this
kind of the transport problem, three code lines in the above example
can be replaced by the following ones: <br>
  </span></p>
  <p><span style="font-family: monospace;">..............................<br>
// &nbsp; &nbsp;&nbsp; m_NodeStatusCH[in] =
NEED_GEM_AIA;&nbsp;&nbsp;&nbsp; // GEM Automatic (simplex) initial
approximation</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
m_NodeStatusCH[in] = NEED_GEM_SIA;&nbsp;&nbsp; // GEM Smart initial
approximation</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
UseNodeSpeciation =
true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// set true for GEM SIA if aqueous species are transported<br>
..............................<br>
  </span></p>
  <p><span style="font-family: monospace;"></span><span
 style="font-family: Helvetica,Arial,sans-serif;">The </span><big><span
 style="font-family: monospace;">UseNodeSpeciation</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> flag, if set to </span><big><span
 style="font-family: monospace;">true</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">, tells the program
to take the (modified) speciation from </span><big><span
 style="font-family: monospace;">xDC</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> vector as the
initial
approximation together with the activity coefficients </span><big><span
 style="font-family: monospace;">gam</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> (the latter
are usually not modified in the mass transport part). If this flag is
set to false then the </span><big><span style="font-family: monospace;">xDC</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> and </span><big><span
 style="font-family: monospace;">gam</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> vectors will not be
copied into the
MULTI structure and instead, the previous internal contents of the
speciation
vector </span><big><span style="font-family: monospace;">x</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> and activity
coefficients </span><span
 style="font-family: Helvetica,Arial,sans-serif;">vector</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> </span><big><span
 style="font-family: monospace;">lnGam</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">&nbsp; will be used
as initial
approximation. This may be the only possible SIA mode for pure
advection coupled problems where the whole fluid composition is moved
but not single species. A disadvantage in this case is that the changed
  </span><big><span style="font-family: monospace;">bIC</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> vector is no more </span><span
 style="font-family: Helvetica,Arial,sans-serif;">mass balance</span><span
 style="font-family: Helvetica,Arial,sans-serif;">- compatible with the
speciation inherited from
the previous node. This may lead to multiple
EFD() iterations or more frequent internal switches to AIA mode, hence
the acceleration of GEM calculations may only be moderate. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The TNode
class contains several overloaded forms of the </span><big><span
 style="font-family: monospace;">GEM_from_MT()</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> function
which loads input data into the work DATABR structure before launching
the
GEM calculation for a given node. The simplest form does not transfer
the speciation vector at all and can be used when GEM is started in AIA
mode or in SIA mode with </span><big><span
 style="font-family: monospace;">UseNodeSpeciation = false.<span
 style="font-family: Helvetica,Arial,sans-serif;"> The&nbsp; variant
used in the above code example sends </span><span
 style="font-family: monospace;">bIC</span><span
 style="font-family: Helvetica,Arial,sans-serif;">,&nbsp; </span><span
 style="font-family: monospace;">xDC</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> and </span><span
 style="font-family: monospace;">gam</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> vectors as
they are available in the transport part data arrays. <br>
  </span></span></big></p>
  <p><big><span style="font-family: monospace;"><span
 style="font-family: Helvetica,Arial,sans-serif;">Finally, there is
a call which transmits the </span><span style="font-family: monospace;">xDC</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> vector with new
species amounts (or their changes relative to previous time step), and
the </span><span style="font-family: monospace;">bIC</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> vector
zeroed off (or unchanged since the previous time step, respectively).
In this case, the TNode class adds the </span><span
 style="font-family: monospace;">xDC</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> increments to the
previous contents of the x vector in the MULTI
structure, computes the bulk composition increments, adds those to </span><span
 style="font-family: monospace;">bIC</span><span
 style="font-family: Helvetica,Arial,sans-serif;">
vector in work DATABR structure and copies the contents of </span><span
 style="font-family: monospace;">bIC</span><span
 style="font-family: Helvetica,Arial,sans-serif;">&nbsp; to
the </span><span style="font-family: monospace;">b</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> vector of the MULTI
structure. In other words, the mass-transport
part can leave the work on balancing the bulk composition vector </span><span
 style="font-family: monospace;">bIC</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> to GEMIPM2K. For the
case when the </span><span style="font-family: monospace;">xDC</span><span
 style="font-family: Helvetica,Arial,sans-serif;"> vector must receive
the full node speciation changed over the time step, the following code
fragment is needed: <br>
  </span></span></big></p>
  <p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <big><span
 style="font-family: monospace;"><span
 style="font-family: Helvetica,Arial,sans-serif;"></span></span></big><span
 style="font-family: monospace;"><span
 style="font-family: Helvetica,Arial,sans-serif,mon;"></span> </span><span
 style="font-family: monospace;">// . . . . . . . . . . . . . . . . <br>
&nbsp;&nbsp;&nbsp;&nbsp; // Setting input data for GEM IPM</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; for(
int i=0; i&lt;nIC; i++ )<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m_bIC[in*nIC+i] = 0.0;<br>
&nbsp;&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp; node-&gt;GEM_from_MT( m_NodeHandle[in],
m_NodeStatusCH[in],</span><span style="font-family: monospace;">
m_T[in], m_P[in], <br>
&nbsp;&nbsp;&nbsp;&nbsp; m_Vs[in], m_Ms[in],</span><span
 style="font-family: monospace;"> m_bIC+in*nIC, m_dul+in*nDC,
m_dll+in*nDC, m_aPH+in*nPH, </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; m_xDC+in*nDC ); <br>
  </span><span style="font-family: monospace;"></span><span
 style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; //
Calling GEM IPM2 calculation</span><span style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
m_NodeStatusCH[in] = node-&gt;GEM_run( UseNodeSpeciation );<br>
&nbsp;&nbsp;&nbsp;&nbsp; // . . . . . . . . . . . . . . . . <br>
  </span></p>
  <p><span style="font-family: monospace;"></span><span
 style="font-family: Helvetica,Arial,sans-serif;">This call also
calculates the new bIC contents with mass balance residuals as
paintained by the mass-transport part. </span><br
 style="font-family: Helvetica,Arial,sans-serif;">
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">To achieve better
stability of GEM calculations, especially if the nodes differ in size,
an overloaded call can be used:<br>
  </p>
  <p style="font-family: monospace; margin-left: 40px;">// Calls GEM
for a work node - an overloaded variant which scales the system <br>
//&nbsp;&nbsp; provided in DATABR and DATACH multiplying by a factor
InternalMass/Ms before <br>
//&nbsp;&nbsp; calling GEM and the results by Ms/InternalMass after the
GEM calculation<br>
//&nbsp;&nbsp; <br>
  <span style="font-family: monospace;">m_NodeStatusCH[in] =</span>
GEM_run( 3., <span style="font-family: monospace;">UseNodeSpeciation</span>
);&nbsp;&nbsp; <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;"></p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The fist
parameter (<big><span style="font-family: monospace;">InternalMass</span></big>)
in this call tells the program the mass of reactive chemical system
that must be used internally in the IPM data structure for the GEM
calculation. Re-scaling is performed automatically. The <big><span
 style="font-family: monospace;">InternalMass</span></big> parameter
should be set between 0.1 and 10 kg. The node reactive mass&nbsp; <big><span
 style="font-family: monospace;">Ms</span></big>&nbsp; can be in the
range from 1 mg to 1000000 kg. <br>
  <br>
  <br>
  </p>
  <h3><a name="TNODEARRAY"></a>2.6. The TNodeArray Class - a Data
Storage for Developing New Coupled Codes </h3>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Using the
TNodeArray class, you can implement a simple direct coupling scheme
between FMT and GEM part in a single-GEM-call fashion, assuming that
the node-specific chemical speciation and transport properties are kept
in two node arrays C0 and C1. The<br>
TNodeArray class implements a flexible C/C++ interface between GEM
IPM2K and FMT codes. It works with one DATACH and many DATABR memory
structures fully using the TNode class functionality. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The basic
idea of TNodeArray class is to maintain two arrays of pointers to
DATABR structures: one array C0 for the previous (</span><big><span
 style="font-family: monospace;">t0</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">) and one C1 for the
current time (</span><big><span style="font-family: monospace;">t1</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">).&nbsp; The DATABR
structures keeping information for each node are dynamically allocated.
The mass transport part takes data for nodes from the C0 layer of the
node array and puts modified speciation, composition, or temperature
for each node in the respective structure linked to the C1 layer of the
node array. The GEM calculations (chemical equilibration) are always
performed over the nodes in C1 node array layer. Then, in the
(oprional) back-coupling algorithm, the decision about the acceptance
of the time step </span><big><span style="font-family: monospace;">dt</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> is made. The time
step can always be made smaller and the transport loop can be repeated,
if necessary, followed by the chemical&nbsp; equilibration loop. Only
when the time step is accepted, the data for each node are copied into
the respective DATABR structures in the C0 node array. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Code
fragments below illustrate how the TNodeArray functionality can be used
in implementing a new coupled RMT code (see also </span><big><span
 style="font-family: monospace;">main.cpp</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">&nbsp; file in&nbsp; </span><big><span
 style="font-family: monospace;">nodearray-gem/</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> subdirectory).&nbsp;
At the first step, two node arrays are allocated using the TNodeArray
constructor. Then the initial distribution index list </span><big><span
 style="font-family: monospace;">nodeIn[] </span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">is defined, and the
GEMIPM2K input files are read in.&nbsp; The contents of</span><big><span
 style="font-family: monospace;"> nodeIn</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> tell the program
where to copy the contents of just read DBR file. In this way, the </span><big><span
 style="font-family: monospace;">GEM_init()</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> function initializes
the </span><big><span style="font-family: monospace;">C0&nbsp;</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> layer of the node
array. <br>
  </span></p>
  <p style="font-family: monospace;">#include "nodearray.h"<br>
const int nNodes =&nbsp; 10;&nbsp;&nbsp; // set here how many nodes you
need<br>
const int nTimes = 20;&nbsp;&nbsp;&nbsp; // set here how many time
loops will be performed<br>
  <br>
int main( int argc, char* argv[] )<br>
{<br>
&nbsp;&nbsp;&nbsp; . . . . . . . . . . . . . . <span
 style="font-family: monospace;"></span><span
 style="font-family: monospace;"><br>
&nbsp;&nbsp;&nbsp; TNodeArray* na;</span><span
 style="font-family: monospace;"><br>
&nbsp;&nbsp;&nbsp; // The NodeArray must be allocated here</span><span
 style="font-family: monospace;"><br>
&nbsp;&nbsp;&nbsp; TNodeArray::na = na = new TNodeArray( nNodes );</span><br
 style="font-family: monospace;">
  </p>
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; // Prepare
the index array for initial node system and boundary condition codes</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; int
nodeIn[nNodes] = { 0, 1, 1, 1, 1, 1, 1, 1, 1, 1 };</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; int Mode,
RetCode; </span><br style="font-family: monospace;">
  <br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; // Here we
read the IPM, DCH and DBR files prepared from GEMS_PSI</span><span
 style="font-family: monospace;">. <br>
&nbsp;&nbsp;&nbsp; // There must be two DBR files prepared - the first
will be loaded into <br>
&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp; the node 0 and </span><span
 style="font-family: monospace;">the second - into nodes 1 until 9. </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; if(
na-&gt;GEM_init( ipm_input_file_list_name, nodeIn ) )</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 1;&nbsp;&nbsp; // error reading files</span><br
 style="font-family: monospace;">
  <br>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">The next
step usually consists in getting direct access to node array layers: </span><br>
  <span style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; DATABRPTR*
C0 = na-&gt;pNodT0();&nbsp; // nodes at previous time point</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; DATABRPTR*
C1 = na-&gt;pNodT1();&nbsp; // nodes at next time point</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; bool* iaN =
na-&gt;piaNode();&nbsp;&nbsp;&nbsp;&nbsp; // indicators for AIA (true)
or SIA (false) for the nodes</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;</span><br
 style="font-family: monospace;">
  <br style="font-family: monospace;">
  <span style="font-family: Helvetica,Arial,sans-serif;">After that,
the mass transport parameters can be set for each node. For instance,
your own input file can be read here. The data for each node are
inserted in the node array as follows:</span><span
 style="font-family: monospace;"><br>
  </span><span style="font-family: monospace;">&nbsp;&nbsp; </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; for( int
in=0; in&lt;nNodes; in++) // Loading mass transport parameters</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; {</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; C0[in]-&gt;NodeTypeHY = normal; </span><span
 style="font-family: monospace;"><br>
&nbsp; &nbsp; &nbsp;&nbsp;&nbsp; C0[in]-&gt;Vt =
1.;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; C0[in]-&gt;vp = 1e-7;&nbsp; // cin &gt;&gt; </span><span
 style="font-family: monospace;">C0[in]-&gt;vp; </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; C0[in]-&gt;eps = 0;</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; C0[in]-&gt;Km = 0;</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; C0[in]-&gt;al = 0;</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; C0[in]-&gt;Dif = 0;</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; C0[in]-&gt;hDl = 0; //
C0[j]-&gt;al*C0[j]-&gt;vp+C0[j]-&gt;Dif;</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; C0[in]-&gt;nto = 0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span><span
 style="font-family: monospace;">cin &gt;&gt; C0[in]-&gt;TC;</span><br>
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
iaN[in] = true;&nbsp; <br style="font-family: monospace;">
  </span><span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
}</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
C0[0]-&gt;NodeTypeHY = NBC3source; </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
C0[nNodes-1]-&gt;NodeTypeHY = NBC3sink; </span><span
 style="font-family: Helvetica,Arial,sans-serif;"><br>
  </span> </p>
  <p><big><span style="font-family: monospace;">C0[in] </span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">is here a </span><big><span
 style="font-family: monospace;">DATABR</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> pointer to the node
with index </span><big><span style="font-family: monospace;">in</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;">. Hence, the
identifiers like </span><big><span style="font-family: monospace;">vp</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> or </span><big><span
 style="font-family: monospace;">Dif</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> are just names of </span><big><span
 style="font-family: monospace;">DATABR </span></big><br>
  <span style="font-family: Helvetica,Arial,sans-serif;">structure
fields (see </span><big><span style="font-family: monospace;">databr.h</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> file). In this loop,
additional modifications to bulk composition or temperature can be
added, if necessary. The nodes from 1 to 8 are set as normal nodes. The
node with </span><big><span style="font-family: monospace;">in=0</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> is set as a Cauchy
source and the node with </span><big><span
 style="font-family: monospace;">in=9</span></big><span
 style="font-family: Helvetica,Arial,sans-serif;"> - as a Cauchy sink
boundary condition. <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">To complete
initialization of node array layers, a loop over nodes is performed,
where the nodes are copied from level C0 to level C1, and chemical
equilibria are initially calculated:<br>
  </span></p>
  <p><span style="font-family: monospace;">&nbsp;&nbsp; for ( int in=0;
in&lt;nNodes; in++)&nbsp; // Copying node layer 0 to node layer 1&nbsp;
  </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;
{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// (for MT models that can reset time step dt) </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Mode = NEED_GEM_AIA; </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; na-&gt;CopyNodeFromTo( in, nNodes, C0, C1 )</span><span
 style="font-family: monospace;">;</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
RetCode = na-&gt;RunGEM( in, Mode ); // running GEM for the in-th node</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if( !(RetCode==OK_GEM_AIA || RetCode == OK_GEM_SIA ))</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 5; </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  </span><span style="font-family: monospace;">na-&gt;CopyNodeFromTo(
in, nNodes, C1, C0 )</span><span style="font-family: monospace;">;</span><br>
  <span style="font-family: monospace;">&nbsp;&nbsp; } </span><br
 style="font-family: monospace;">
  <span style="font-family: Helvetica,Arial,sans-serif;">&nbsp; <br>
  </span></p>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Now both
layers are identical at time 0. The transport simulation time loop can
begin. <br>
  <br>
  </span><span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp; . . . . . . . . . . . . .
. . . . . <br>
&nbsp;&nbsp; bool TimeStepAccept; // Flag set to true if the time step
dt is accepted</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; double ct = 0., dt
= 1.;<br>
&nbsp;&nbsp; int xiSr = na-&gt;IC_name_to_xDB("Sr");&nbsp; //
Retrieving DATABR index for independent component Sr <br>
&nbsp;&nbsp; int xiCl = na-&gt;IC_name_to_xDB("Cl");&nbsp; // same for
Cl (assuming that both are present in DCH <br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp; // and DBR files)<br>
&nbsp;&nbsp; if( xiSr &lt; 0 || xiCl &lt; 0 )<br>
&nbsp; &nbsp; &nbsp; return 4; &nbsp;&nbsp; // error - data for one of
these elements is not present in DATABR<br>
  </span></p>
  <p><span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp; FILE*
logfile;&nbsp;&nbsp;&nbsp; // Opening file for logging results <br>
&nbsp;&nbsp; logfile = fopen( logging_file_name, "w+" );&nbsp;&nbsp; <br>
&nbsp;&nbsp; if( !logfile)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return -1;</span></p>
  <p><span style="font-family: monospace;">&nbsp;&nbsp; for( int it=0;
it&lt;nTimes; it++ )&nbsp; // iterations over time</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; {</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; int
in;&nbsp; // node index</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; ct +=
dt;&nbsp; // current time increment</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; iaN[0]
= false; </span><br style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; // Loop over
nodes for calculating the mass transport step</span><span
 style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
for(&nbsp; in=1; in&lt;nNodes; in++ )</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; {</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
iaN[in] = false; // true;&nbsp; // SIA mode of GEMIPM2 is allowed for
this node </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// In this place, add operators as function of tc and dt that transfer
the matter </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// between the nodes according to transport model of choice. <br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; // Take care about the mass
conservation. </span><span style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// in this example, we add SrCl2 to the old bIC vector of the previous
node at </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// previous time to modify composition in this node at the next time
step</span><br style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;"></span><span
 style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;
node1_bIC( in, xiSr ) = node0_bIC( in-1, xiSr ) += dt *</span><span
 style="font-family: monospace;"> C0[in]-&gt;vp</span><span
 style="font-family: monospace;"> * 1.; </span><span
 style="font-family: Helvetica,Arial,sans-serif;"><br>
  </span><span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;
node1_bIC( in, xiCl ) = node0_bIC( in-1, xiCl ) += dt *</span><span
 style="font-family: monospace;"> C0[in]-&gt;vp</span><span
 style="font-family: monospace;"> * 2.;<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; . . . . . . . . . . . . . . . . .
. . </span><br>
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
//&nbsp; Uncomment this to test variable pressures and temperatures</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
//&nbsp; C1[in]-&gt;TC = C0[in-1]-&gt;TC + 0.2;</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
//&nbsp; C1[in]-&gt;P = C0[in-1]-&gt;P + 2.;</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
//&nbsp; . . . . . . . . . . . . . . . . . . </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; }</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; // </span><span
 style="font-family: monospace;">The above loop can be replaced by a
function call that performs the MT integration step</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; //
Here the file output may be inserted<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; . . . . . . . . . . . . . . . . . . . .
  <br style="font-family: monospace;">
  </span><span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
// Loop over nodes for calculating the chemical equilibration step</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; for(
in=0; in&lt;nNodes; in++ )</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; {</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if( iaN[in] )</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
C1[in]-&gt;NodeStatusCH = NEED_GEM_AIA; // Automatic (simplex) initial
approximation AIA</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
else</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; C1[in]-&gt;NodeStatusCH = NEED_GEM_SIA; // Smart
initial approximation SIA - faster</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// Here we can also check if the GEM calculation for this node is
needed at all</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
// e.g. by comparing this node in C1 layer with that in C0 layer</span><span
 style="font-family: monospace;"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if( in == 0 )&nbsp; // First node
(Cauchy source) is not re-equilibrated since it is not changed</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
NeedGEM = false;</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
else NeedGEM = true; </span><br style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
node1_bIC( in, xiZz ) = 0.;&nbsp;&nbsp; // zeroing charge off in node
bulk composition</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if( !NeedGEM ) </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
{&nbsp;&nbsp; // GEM calculation for this node not needed</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp; C1[in]-&gt;IterDone = 0; // number of GEMIPM iterations is
set to 0</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
else {// Calling GEM IPM2 calculation</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; Mode = C1[in]-&gt;NodeStatusCH; // mode
of initial aproximation </span><br style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp; RetCode = na-&gt;RunGEM( in, Mode ); //
running GEM for the node in (node layer C1) </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if( !(RetCode==OK_GEM_AIA || RetCode == OK_GEM_SIA ))</span><span
 style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span
 style="font-family: monospace;"></span><span
 style="font-family: monospace;">return 5; </span><span
 style="font-family: monospace;">&nbsp; </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}&nbsp;&nbsp;&nbsp; </span><span style="font-family: monospace;"></span><span
 style="font-family: monospace;"></span><span
 style="font-family: monospace;"></span><span
 style="font-family: monospace;"></span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; } //
end of node equilibration loop</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; . . .
. . . . . . . . . . . . . . .</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; //
Here back-coupling of phase equilibrium data with transport parameters,<br>
&nbsp; &nbsp;&nbsp; // as well as various checks for the acceptance of
the time step can be performed </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
TimeStepAccept = true;&nbsp; // false; </span><span
 style="font-family: monospace;"><br>
&nbsp; &nbsp;&nbsp; . . . . . . . . . . . . . . . . . . &nbsp;&nbsp; </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; if(
TimeStepAccept ) // Time step accepted </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
for ( in=1; in&lt;nNodes; in++)&nbsp; // Copying node layer C1 to node
layer C0 </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
na-&gt;CopyNodeFromTo( in, nNodes, C1, C0 );</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; else {
  </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; if(dt &gt; 1e-3) </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; {</span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ct-= dt;</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; dt /= 2.; // Trying the time loop
again with twice smaller time step</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; }</span><br style="font-family: monospace;">
  <span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
else <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 6; </span><span style="font-family: monospace;">// Error: Time
step dt becomes too small&nbsp;&nbsp;&nbsp;&nbsp; </span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; }</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; //
Here the output for the current state at tc can be implemented</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; . . .
. . . . . . . . . . . . . . . .<br>
  </span><span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;
na-&gt;logProfileAqIC( logfile, it, ct, nNodes, 5 ); // logging
elemental molarity profiles over <br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; // for every fifth time step <br>
&nbsp;&nbsp;&nbsp;&nbsp; // </span><span
 style="font-family: monospace;">na-&gt;logProfilePhVol( logfile, it,
ct, nNodes, 5 );</span><span style="font-family: monospace;"> //
logging phase volumes at time step<br style="font-family: monospace;">
  </span><span style="font-family: monospace;"></span><span
 style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp; . . . . . . .
. . . . . . . . . . . .<br>
&nbsp; &nbsp;&nbsp; dt = 1; &nbsp; // re-setting time step</span><br
 style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp;&nbsp; } // End of time
loop&nbsp; </span><br style="font-family: monospace;">
  <span style="font-family: monospace;">&nbsp; </span><br
 style="font-family: monospace;">
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">When the coupled
modeling is finished, the whole cleanup of node array with its dynamic
data is done by calling the destructor:</p>
  <p style="margin-left: 40px;"><span style="font-family: monospace;">delete
na;</span><br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">As seen from the
above code fragments, the TNodeArray class takes care of the most
routine operations, thus letting the developer concentrate mainly on
the transport and back-coupling model. The <big><span
 style="font-family: monospace;">node.h</span></big> and <big><span
 style="font-family: monospace;">nodearray.h</span></big> files contain
many functions and macroses for accessing most of the chemical data
stored for nodes at C0 and C1 levels. &nbsp; <br>
  </p>
  <br style="font-family: Helvetica,Arial,sans-serif;">
  <br>
  <br>
  <br>
  <br>
  <br>
  <h3 style="font-family: Times New Roman,Times,serif;"><a
 name="NUMERICAL_CONTROLS"></a>2.7. Numerical controls of GEMIPM2K
operation</h3>
  <br>
  <p> </p>
  <hr size="2" width="100%">
  <h2><br>
  </h2>
  <h2><a name="REQUIREMENTS"></a>3. Requirements for Programming</h2>
  <p> Geochemical modeling often requires<br>
  </p>
  <p><br>
  <font face="Helvetica, Arial, sans-serif"></font></p>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="CALLFROMCPP"></a>3.1. When the Calling (FMT)
Program is Written in C/C++ </h3>
  <p><br>
  </p>
  <p><font face="Helvetica, Arial, sans-serif"><br>
  </font></p>
  <h3><font style="font-family: times new roman,times,serif;"
 face="Helvetica, Arial, sans-serif"><a name="CALLFROMFORTRAN"></a>3.2.
When the
Calling (FMT) Program is Written in Fortran </font><br>
  </h3>
  <p><br>
  </p>
  <p><br>
  <br>
  </p>
  <hr size="2" width="100%"><br>
  <br>
  <br>
  <p> </p>
  <h2><a name="COMPILE_PLATFORMS"></a>4. Compilation and Linking of
GEMIPM2K on
Various Platforms <br>
  </h2>
  <dl>
  </dl>
  <br>
introduction <br>
  <br>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="GNUCPP_FOR"></a>4.1. GNU C++ (gcc - gfortran)<br>
  </h3>
  <p style="font-family: times new roman,times,serif;"><br>
  </p>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="PGICPP_FOR"></a>4.2. Portland Group C++ (pgcc- pgf)<br>
  </h3>
  <p style="font-family: times new roman,times,serif;"><br>
  </p>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="MSVCPP_DIGIFOR"></a>4.3. MS Visual C++ (with Digital Fortran)<br>
  </h3>
  <p style="font-family: times new roman,times,serif;"><br>
  </p>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="BORLANDCPP"></a>4.4. Borland C++<br>
  </h3>
  <font face="Helvetica, Arial, sans-serif"><br>
  <br>
  </font>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="OTHER_COMPILERS"></a>4.5. Other compilers and linkers</h3>
  <br>
  <font face="Helvetica, Arial, sans-serif"><br>
  </font>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="SVN_REP"></a>4.6. Subversion Repository of GEMIPM2K<br>
  </h3>
  <br>
  <dl>
    <br>
  </dl>
&nbsp; <br>
  <hr size="2" width="100%"><br>
  <h2><a name="INPUT_FILES"></a>5. Input Files <br>
  </h2>
  <p> Geochemical modeling often requires&nbsp; </p>
  <h4><span style="font-family: Helvetica,Arial,sans-serif;"><a
 name="PRODUCE_FILES_S"></a>How to produce GEMIPM2 input text files
from "Single Thermodynamic System" dialog in GEMS-PSI<br>
  </span></h4>
  <p><span style="font-family: Helvetica,Arial,sans-serif;">Select and
load a required SysEq record. Then go to menu "Data"
and then "Write IPM files". In the appearing list of independent
components, mark those you wish to handle in DBR files (or select all)
and click "Ok". In the next list, select dependent components (chemical
species) to be handled in DBR files (or select all) and click "Ok". In
the next list, select phases to be handled in DBR files (or select
all), and press "Ok". Finally, in the appearing file dialog, give a
name to the file set and select a directory (or create a new one) where
to write the files. The GEMIPM2K text files produced in this way are
immediately readable by GEMIPM2K.</span> </p>
&nbsp; <br>
  <hr size="2" width="100%"><br>
  <h2><a name="TEST_EXAMPLES"></a>6. Test Examples <br>
  </h2>
  <p> Geochemical modeling often requires&nbsp; </p>
  <p style="font-family: times new roman,times,serif;"><br>
  </p>
  <h3><font style="font-family: times new roman,times,serif;"
 face="Helvetica, Arial, sans-serif"><a name="TEST_TNODE"></a>6.1.
TNode Level</font></h3>
  <font style="font-family: times new roman,times,serif;"
 face="Helvetica, Arial, sans-serif"></font> <font
 style="font-family: times new roman,times,serif;"
 face="Helvetica, Arial, sans-serif"><br>
  <br>
  </font>
  <h3><font style="font-family: times new roman,times,serif;"
 face="Helvetica, Arial, sans-serif"><a name="TEST_TNODEARRAY"></a>6.2.
TNodeArray Level</font></h3>
  <dl>
    <br style="font-family: times new roman,times,serif;">
    <span style="font-family: times new roman,times,serif;">&nbsp; </span><br>
    <br>
  </dl>
  <hr size="2" width="100%"><br>
  <h2><a name="REFERENCES"></a>7. References</h2>
  <a name="Ref_Bethke-1996"></a> Bethke, 1996 (<a
 href="http://hercules.geology.uiuc.edu/%7Ebethke/hydro_gwb.htm">http://hercules.geology.uiuc.edu/~bethke/hydro_gwb.htm</a>)<br>
  <br>
  <a name="Ref_Bruno_ea_2007"></a> Bruno J.,
Bosbach D., Kulik D., Navrotsky A. (2007): <i>Chemical
thermodynamics of solid solutions of interest in radioactive waste
management: A state-of-the art report</i>, Eds.
F.J.Mompean, M.Illemassene, J.Perrone, Chemical Thermodynamics Series
Vol. <span style="font-weight: bold;">10</span>, Paris, OECD, 292 p.
(<a href="http://www.nea.fr/html/dbtdb/info/publications/welcome.html">http://www.nea.fr/html/dbtdb/info/publications/welcome.html</a>)<br>
  <br>
  <a name="Ref_TM-44-02-06"></a> Chudnenko K.V. et al. TM-44-02-06 <br>
  <br>
  <a name="Ref_Dmytrieva-2008"></a>Dmytrieva S.V. et al. 2008
TM-44-08-XY<br>
  <br>
  <a name="Ref_Karpov-ea-2001"></a> Karpov I.K.,
Chudnenko
K.V., Kulik D.A., Avchenko O.V. and Bychinski V.A. (2001). Minimization
of Gibbs free energy in geochemical systems by convex programming.
Geochemistry International <span style="font-weight: bold;">39</span>(11),
1108-1119. <br>
  <br>
  <a name="Ref_Karpov-ea-1997"></a> Karpov I.K.,
Chudnenko
K.V.
and Kulik D.A. (1997): Modeling chemical mass-transfer in geochemical
processes: Thermodynamic relations, conditions of equilibria and
numerical algorithms.
American Journal of Science <span style="font-weight: bold;">297</span>,
767-806<br>
  <br>
  <a name="Ref_Kulik-ea-2004"></a> Kulik D.,
Berner U., Curti E.
(2004): Modelling chemical equilibrium partitioning with the GEMS-PSI
code. In: PSI Scientific Report 2003 / Volume <span
 style="font-weight: bold;">IV</span>, Nuclear Energy and
Safety (edited by B.Smith and B.Gschwend), Paul Scherrer Institute,
Villigen, Switzerland, March 2004, p.109-122 (ISSN 1423-7334) (<a
 href="http://gems.web.psi.ch/">http://gems.web.psi.ch/</a>)<br>
  <br>
  <a name="Ref_Kulik_ea-2008"></a> Kulik D. et al. (2008) TM-44-08-XX<br>
  <br>
  <a name="Ref_Morel-Hering-1993"></a> Morel and Hering, 1993 <br>
  <br>
  <a name="Ref_Parkhurst-Appelo-1999"></a> Parkhurst and Appelo, 1999 (<a
 href="http://wwwbrr.cr.usgs.gov/projects/GWC_coupled/phreeqc/%29">http://wwwbrr.cr.usgs.gov/projects/GWC_coupled/phreeqc/)</a><br>
  <br>
  <a name="Ref_Reed-1982"></a> Reed, 1982<br>
  <br>
  <a name="Ref_van-der-Lee-1998"></a> van der Lee J. (1998):
Thermodynamic and mathematical concepts of CHESS, Technical Report Nr.
LHM/RD/98/39, Ecole des Mines de Paris, Fontaineleau, France&nbsp; (<a
 href="http://chess.ensmp.fr/doc.html">http://chess.ensmp.fr/doc.html</a>).<br>
  <br>
  <a name="Ref_Van-Zeggeren-1970"></a> Van Zeggeren and Storey,
1970<br>
  <br>
  <br>
  <br>
To
Contents
&nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;<tt>About GEMIPM2K </tt><br>
  <tt><br>
end of file</tt> <br>
&nbsp;<br>
  <p><br>
&nbsp; </p>
  <br>
  <br>
</blockquote>
</body>
</html>
